<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="en">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://yoursite.com/page/3/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/page/3/"/>





  <title>Hexo</title>
  








<meta name="generator" content="Hexo 4.2.1"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Hexo</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/%20" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/%20" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/03/18/universe/database/Redis_study_note/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/03/18/universe/database/Redis_study_note/" itemprop="url">Redis 学习笔记</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-03-18T00:00:00+08:00">
                2020-03-18
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Redis学习笔记"><a href="#Redis学习笔记" class="headerlink" title="Redis学习笔记"></a>Redis学习笔记</h1><h2 id="基本认识"><a href="#基本认识" class="headerlink" title="基本认识"></a>基本认识</h2><ul>
<li>Redis 是单线程的, 也就是说在处理不当会导致阻塞<ul>
<li>不要使用长命令, 如: keys *</li>
</ul>
</li>
</ul>
<h3 id="特性"><a href="#特性" class="headerlink" title="特性"></a>特性</h3><ul>
<li>高速<ul>
<li>内存中进行的</li>
</ul>
</li>
<li>&lt;++&gt;</li>
<li>&lt;++&gt;</li>
<li>&lt;++&gt;</li>
<li>&lt;++&gt;</li>
<li>&lt;++&gt;</li>
<li>&lt;++&gt;</li>
</ul>
<h2 id="通用命令"><a href="#通用命令" class="headerlink" title="通用命令"></a>通用命令</h2><h3 id="get"><a href="#get" class="headerlink" title="get"></a>get</h3><table>
<thead>
<tr>
<th>command</th>
<th>desc</th>
<th>T(n)</th>
</tr>
</thead>
<tbody><tr>
<td>keys [pattern]</td>
<td>根据通配符号检索key</td>
<td>O(n)</td>
</tr>
<tr>
<td>get key</td>
<td>获取value</td>
<td>O(1)</td>
</tr>
<tr>
<td>mget key1 key2…</td>
<td>批量获取value</td>
<td>O(n)</td>
</tr>
<tr>
<td>getset key newvalue</td>
<td>set key newvalue并反会旧的value</td>
<td>O(1)</td>
</tr>
<tr>
<td>append key value</td>
<td>追加</td>
<td>O(1)</td>
</tr>
<tr>
<td>strlen key</td>
<td>长度</td>
<td>O(1)</td>
</tr>
</tbody></table>
<h3 id="set"><a href="#set" class="headerlink" title="set"></a>set</h3><table>
<thead>
<tr>
<th>command</th>
<th>desc</th>
<th>T(n)</th>
</tr>
</thead>
<tbody><tr>
<td>set key value</td>
<td>设置 key value</td>
<td>O(1)</td>
</tr>
<tr>
<td>mset key1 value1 key2 value2…</td>
<td>批量设置 key value</td>
<td>O(1)</td>
</tr>
<tr>
<td>setnx key value</td>
<td>如果key不存在,设置 key value</td>
<td>O(1)</td>
</tr>
<tr>
<td>set key value xx</td>
<td>如果key存在,设置 key value</td>
<td>O(1)</td>
</tr>
<tr>
<td>dbsize</td>
<td>计算key总数</td>
<td>O(1)</td>
</tr>
<tr>
<td>exists key</td>
<td>判断存在</td>
<td>O(1)</td>
</tr>
<tr>
<td>del key [key …]</td>
<td>删除</td>
<td>O(1)</td>
</tr>
<tr>
<td>expire key seconds</td>
<td>key在seconds秒后过期</td>
<td>O(1)</td>
</tr>
<tr>
<td>ttl key</td>
<td>查看过期时间, -1没设置过期, -2已过期</td>
<td>O(1)</td>
</tr>
<tr>
<td>persist key</td>
<td>去掉过期时间</td>
<td>O(1)</td>
</tr>
<tr>
<td>type key</td>
<td>返回类型</td>
<td>O(1)</td>
</tr>
</tbody></table>
<h3 id="字符串"><a href="#字符串" class="headerlink" title="字符串"></a>字符串</h3><table>
<thead>
<tr>
<th>command</th>
<th>desc</th>
<th>T(n)</th>
</tr>
</thead>
<tbody><tr>
<td>getrange key start end</td>
<td>获取字符串指定下标所有值</td>
<td>O(1)</td>
</tr>
<tr>
<td>setrange key index value</td>
<td>设置指定下标对应值</td>
<td>O(1)</td>
</tr>
</tbody></table>
<h3 id="数"><a href="#数" class="headerlink" title="数"></a>数</h3><table>
<thead>
<tr>
<th>command</th>
<th>desc</th>
<th>T(n)</th>
</tr>
</thead>
<tbody><tr>
<td>incr key</td>
<td>自增1</td>
<td>O(1)</td>
</tr>
<tr>
<td>decr key</td>
<td>自减1</td>
<td>O(1)</td>
</tr>
<tr>
<td>incrby key k</td>
<td>自增k</td>
<td>O(1)</td>
</tr>
<tr>
<td>decrby key k</td>
<td>自减k</td>
<td>O(1)</td>
</tr>
<tr>
<td>incrbyfloat key float</td>
<td>自增float</td>
<td>O(1)</td>
</tr>
</tbody></table>
<h3 id="哈希"><a href="#哈希" class="headerlink" title="哈希"></a>哈希</h3><p>结构: key -&gt; (field -&gt; value)</p>
<p>hash的所有命令都是h开头的<br>| command             | desc                         | T(n) |<br>|———————|——————————|——|<br>| hget                | &lt;++&gt;                         | &lt;++&gt; |<br>| hset                | &lt;++&gt;                         | &lt;++&gt; |<br>| hdel                | &lt;++&gt;                         | &lt;++&gt; |<br>| hexists key field   | &lt;++&gt;                         | &lt;++&gt; |<br>| hlen key            | count field                  | &lt;++&gt; |<br>| hmget               | &lt;++&gt;                         | &lt;++&gt; |<br>| hmset               | &lt;++&gt;                         | &lt;++&gt; |<br>| hincrby key value k | incrby k                     | &lt;++&gt; |<br>| hgetall             | get all (field,value) by key | O(n) |<br>| hvals key           | get all values by key        | &lt;++&gt; |<br>| hkeys key           | get all fields by key        | &lt;++&gt; |</p>
<h3 id="列表"><a href="#列表" class="headerlink" title="列表"></a>列表</h3><p>结构: key -&gt; [list]</p>
<p>list的所有命令都是l开头的<br>| command                                 | desc                                                    | T(n)   |<br>|—————————————–|———————————————————|——–|<br>| rpush key value1 value2 …             | 从列表右端插入                                          | O(1-n) |<br>| lpush key value1 value2 …             | 从列表左端插入                                          | O(1-n) |<br>| linsert key before/after value newvalue | 在指定的value前/后插入newvalue                          | O(n)   |<br>| lpop key                                | 从列表左边弹出                                          | O(1)   |<br>| lrem key count value                    | 从左边删除count个value, 删除重复元素, count&lt;0从右边删除 | O(n)   |<br>| ltrim key start end                     | 裁剪出制定范围的元素                                    | O(n)   |<br>| lrange key start end(包含end)           | 获取指定范围的元素                                      | O(n)   |<br>| lindex key index                        | 索引取出                                                | O(n)   |<br>| llen key                                |                                                         | O(1)   |<br>| lset key index newvalue                 | 按照索引修改指                                          | &lt;++&gt;   |</p>
<h3 id="无序集合"><a href="#无序集合" class="headerlink" title="无序集合"></a>无序集合</h3><p>结构: key -&gt; set</p>
<ul>
<li>无需</li>
<li>无重复</li>
<li>支持集合间操作</li>
</ul>
<p>set所有命令s开头<br>| command                             | desc                     | T(n) |<br>|————————————-|————————–|——|<br>| sadd set element                    | insert element           | O(1) |<br>| srem set element                    | delete element           | O(1) |<br>| scard set                           | count element inside set | &lt;++&gt; |<br>| sismenber set                       | check if exists          | &lt;++&gt; |<br>| srandmember set count               | 随机取出count个          | &lt;++&gt; |<br>| spop set                            | 随机弹出1个              | &lt;++&gt; |<br>| smembers set                        | get all element          | &lt;++&gt; |<br>| sdiff set1 set2                     | 差集                     | &lt;++&gt; |<br>| sinter set1 set2                    | 交集                     | &lt;++&gt; |<br>| sunion set1 set2                    | 并集                     | &lt;++&gt; |<br>| sdiff/sinter/sunion + store destkey | 把结果保存到destkey中    | &lt;++&gt; |</p>
<h3 id="有序集合"><a href="#有序集合" class="headerlink" title="有序集合"></a>有序集合</h3><p>结构: key -&gt; (score -&gt; element)</p>
<ul>
<li>element不可重复</li>
<li>顺序由score定</li>
</ul>
<p>有序set所有命令z开头<br>| command                             | desc                                 | T(n)           |<br>|————————————-|————————————–|—————-|<br>| zadd key score element              | &lt;++&gt;                                 | $O(\log n)$    |<br>| zrem key element                    | &lt;++&gt;                                 | &lt;++&gt;           |<br>| zscore key element                  | get score by element                 | O(1)           |<br>| zincrby key increScore element      | 给element增加指定分数                | &lt;++&gt;           |<br>| zcard key                           |                                      | 返回个数       |<br>| zrank                               | 获取排名                             | &lt;++&gt;           |<br>| zrange key start end [withscores]   | 获取范围withscores选项是是否打印分值 | $O(\log(n)+m)$ |<br>| zrangebyscore key minScore maxScore | &lt;++&gt;                                 | &lt;++&gt;           |<br>| zcount key minScore maxScore        | &lt;++&gt;                                 | &lt;++&gt;           |<br>| zremrangebyrank key start end       | &lt;++&gt;                                 | &lt;++&gt;           |<br>| zremrangebyscore key start end      | &lt;++&gt;                                 | &lt;++&gt;           |</p>
<h3 id="慢查询"><a href="#慢查询" class="headerlink" title="慢查询"></a>慢查询</h3><p>生命周期</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">client-&gt;command queue: command</span><br><span class="line">Note right of command queue: Execute one command</span><br><span class="line">command queue--&gt;client: result</span><br></pre></td></tr></table></figure>

<p>慢查询发生在执行命令的过程, 如<code>keys *</code>就会发生慢查询, 通过配置慢查询来防止阻塞</p>
<table>
<thead>
<tr>
<th>配置</th>
<th>结果</th>
</tr>
</thead>
<tbody><tr>
<td>config set slowlog-max-len value</td>
<td>慢查询队列的最大长度为value</td>
</tr>
<tr>
<td>config set slowlog-log-slower-than value</td>
<td>把慢于value微妙的命令放入慢查询队列, 一般设置1微妙</td>
</tr>
<tr>
<td>slowlog get [n]</td>
<td>获取慢查询队列</td>
</tr>
<tr>
<td>slowlog len</td>
<td>获取慢查询队列条数</td>
</tr>
<tr>
<td>slowlog reset</td>
<td>清空</td>
</tr>
</tbody></table>
<h3 id="流水线-Pipline"><a href="#流水线-Pipline" class="headerlink" title="流水线 Pipline"></a>流水线 Pipline</h3><p>网络通信时间 = 网络时间+命令时间</p>
<p>因为redis很快, 通信时间大多数时候受限于网络时间, 而且如果让redis同时mget, mset或者n次set是不行的, 这意味着就需要多次请求, 就会耗费很多时间</p>
<p>流水线的作用就是把一批命令批量打包, 发送到服务端, 然后按顺序反回, 这样n次网络时间就缩短为1次了</p>
<h3 id="发布订阅"><a href="#发布订阅" class="headerlink" title="发布订阅"></a>发布订阅</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">发布者publisher-&gt;频道redis server: 发布消息</span><br><span class="line">频道channle--&gt;订阅者subscribers: 订阅消息给订阅者1</span><br><span class="line">频道channle--&gt;订阅者subscribers: 订阅消息给订阅者2</span><br><span class="line">频道channle--&gt;订阅者subscribers: 订阅消息给订阅者3</span><br><span class="line">Note right of 订阅者subscribers: 每个订阅了频道的人都会收到消息</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>API</th>
<th>desc</th>
</tr>
</thead>
<tbody><tr>
<td>publish channel message</td>
<td>发送message到channel, 返回订阅者数</td>
</tr>
<tr>
<td>subscribe [channel] #一个或多个</td>
<td>订阅</td>
</tr>
<tr>
<td>unsubscribe [channel] #一个或多个</td>
<td>取消订阅</td>
</tr>
</tbody></table>
<p><strong>消息队列</strong> 类似发布订阅, 只是只有一个订阅者能收到, 类似强红包</p>
<h3 id="位图Bitmap"><a href="#位图Bitmap" class="headerlink" title="位图Bitmap"></a>位图Bitmap</h3><p>redis中对位进行操作, 字符串其实就是字符数组嘛, 每个字符又是一段二进制编码</p>
<table>
<thead>
<tr>
<th>API</th>
<th>desc</th>
</tr>
</thead>
<tbody><tr>
<td>setbit key offset value</td>
<td>设置, value只能是0,1</td>
</tr>
<tr>
<td>getbit key offset</td>
<td></td>
</tr>
<tr>
<td>bitcount key [start end]</td>
<td>获取指定范围1的个数</td>
</tr>
<tr>
<td>btop op destkey key [key…]</td>
<td>将多个位图进行交并非异或等操作, 把结果保存到destkey中</td>
</tr>
<tr>
<td>bitpos key tagetBit [start] [end]</td>
<td>计算位图指定范围(start, end单位是字节)第一个偏移量对应的值等于targetBit的位置</td>
</tr>
</tbody></table>
<h3 id="HyperLogLog"><a href="#HyperLogLog" class="headerlink" title="HyperLogLog"></a>HyperLogLog</h3><p>用极小的空间完成独立用户的统计</p>
<ul>
<li>有错误率</li>
<li>不能取单条数据</li>
</ul>
<p>本质结构还是string<br>| API                                      | desc                      |<br>|——————————————|—————————|<br>| pfadd key element [element..]            | 向hyperloglog添加元素     |<br>| pfcount key [key..]                      | 计算hyperloglog的独立总数 |<br>| pfmerge destkey sourcekey [sourcekey…] | 合并多个hyperloglog       |</p>
<h3 id="地理信息定位GEO"><a href="#地理信息定位GEO" class="headerlink" title="地理信息定位GEO"></a>地理信息定位GEO</h3><p>存储经纬度, 计算两地距离, 范围计算等</p>
<table>
<thead>
<tr>
<th>API</th>
<th>desc</th>
</tr>
</thead>
<tbody><tr>
<td>geo key longitude latitude member […]</td>
<td>添加地理位置信息</td>
</tr>
<tr>
<td>geopos key member […]</td>
<td>获取信息</td>
</tr>
<tr>
<td>geodist member1 member2</td>
<td>算距离</td>
</tr>
<tr>
<td>georadius</td>
<td>范围</td>
</tr>
</tbody></table>
<h2 id="持久化"><a href="#持久化" class="headerlink" title="持久化"></a>持久化</h2><p>由于Redis是将数据保存在内存中的, 所以需要持久化来异步的保存到磁盘上</p>
<h3 id="RDB"><a href="#RDB" class="headerlink" title="RDB"></a>RDB</h3><p>生成快照, 保存到硬盘中实现持久化</p>
<p>自动保存默认配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">save 900 1    # 如果900秒内改变了1条内容就自动保存</span><br><span class="line">save 300 10</span><br><span class="line">save 60 10000</span><br><span class="line">dbfilename dump.db  # 默认保存的文件</span><br><span class="line">dir .&#x2F;</span><br><span class="line">stop-writes-on-bgsave-error yes</span><br><span class="line">rdbcompression yes</span><br><span class="line">rdbchecksum yes  # 检验</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>API</th>
<th>desc</th>
<th>T(n)</th>
</tr>
</thead>
<tbody><tr>
<td>save</td>
<td>保存, 会造成阻塞</td>
<td>O(n)</td>
</tr>
<tr>
<td>bgsave</td>
<td>异步保存, 通过子进程来生成RDB, 也会阻塞(发生在fork中), 但非常快</td>
<td>O(n)</td>
</tr>
</tbody></table>
<h3 id="AOF"><a href="#AOF" class="headerlink" title="AOF"></a>AOF</h3><p>RDB的问题</p>
<ul>
<li>耗时, 耗性能<ul>
<li>生成快照会把整个文件保存到硬盘</li>
</ul>
</li>
<li>不可控, 丢失数据<ul>
<li>不论是自动保存还是手动保存, 都不可避免因宕机导致的数据丢失</li>
</ul>
</li>
</ul>
<p>AOF 类似写日志的形式保存每条redis命令, 恢复再根据这些命令恢复</p>
<p>AOF也不是直接把数据写道硬盘中, 那样很慢, 而是将数据写道缓冲区, 再根据策略写到硬盘</p>
<p>AOF的三种策略(默认)</p>
<ul>
<li>always<ul>
<li>每条命令都写到硬盘, I/O开销很大</li>
</ul>
</li>
<li>everysec<ul>
<li>每秒到写到硬盘, 有可能丢失1秒数据</li>
</ul>
</li>
<li>no<ul>
<li>操作系统决定什么时候写就什么时候写</li>
</ul>
</li>
</ul>
<h4 id="AOF重写"><a href="#AOF重写" class="headerlink" title="AOF重写"></a>AOF重写</h4><p>如set同一个key多次只保留最后一次的内容, 不保留过期的命令等等…</p>
<p>AOF重写实现的两种方式</p>
<ul>
<li>bgrewriteaof<ul>
<li>类似bgsave, 在子进程中进行</li>
</ul>
</li>
<li>使用重写配置<ul>
<li>配置<ul>
<li><code>auto-aof-rewrite-min-size</code>: AOF文件重写需要的尺寸</li>
<li><code>auto-aof-rewrite-percentage</code>: AOF文件重写需要的增长率</li>
</ul>
</li>
<li>统计<ul>
<li><code>aof_current_size</code>: AOF当前尺寸(字节)</li>
<li><code>aof_base_size</code>: AOF上次启动和重写的尺寸</li>
<li>配合配置就可以在一定时机重写</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>可用AOF配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">appendonly yes</span><br><span class="line">appendfilename &quot;appendonly-$&#123;port&#125;.aof&quot;</span><br><span class="line">appendsync everysec</span><br><span class="line">dir .&#x2F;bigdiskpath</span><br><span class="line">no-appendfsync-on-rewrite yes</span><br><span class="line">auto-aof-rewite-percentage 100</span><br><span class="line">auto-aof-rewite-min-size 64mb</span><br></pre></td></tr></table></figure>


<h3 id="RDB和AOF选择"><a href="#RDB和AOF选择" class="headerlink" title="RDB和AOF选择"></a>RDB和AOF选择</h3><table>
<thead>
<tr>
<th>命令</th>
<th>ROD</th>
<th>AOF</th>
</tr>
</thead>
<tbody><tr>
<td>启动优先级</td>
<td>低</td>
<td>高</td>
</tr>
<tr>
<td>体积</td>
<td>小</td>
<td>大</td>
</tr>
<tr>
<td>恢复速度</td>
<td>快</td>
<td>慢</td>
</tr>
<tr>
<td>数据安全性</td>
<td>丢失数据</td>
<td>有策略据定</td>
</tr>
<tr>
<td>轻重</td>
<td>重</td>
<td>轻</td>
</tr>
</tbody></table>
<h2 id="Redis复制原理"><a href="#Redis复制原理" class="headerlink" title="Redis复制原理"></a>Redis复制原理</h2><h3 id="主从复制"><a href="#主从复制" class="headerlink" title="主从复制"></a>主从复制</h3><p>单机运行redis可能面临许多风险, I/O瓶颈, 宕机风险, qbs瓶颈. 等等问题</p>
<p>使用redis的主从复制就能很方便是实现一个高可用的分布式数据库</p>
<ul>
<li>一个master可以有多个slave</li>
<li>一个slave只能有一个master</li>
<li>数据流向是单向的, master到slave</li>
</ul>
<p>redis中从节点slave相当于主节点master的备份, 当master中<code>set key value</code>后, 从节点也进行的同样的操作</p>
<h3 id="实现方式"><a href="#实现方式" class="headerlink" title="实现方式"></a>实现方式</h3><ul>
<li>命令实现: <ul>
<li><code>redis-6380&gt; slaveof 127.0.0.1 6379</code>6380成为6379的从复制</li>
<li>取消复制<code>slaveof no one</code>, 不成为任何人的从节点</li>
</ul>
</li>
<li>修改配置文件<ul>
<li><code>slave of ip port</code></li>
<li><code>slave-read-only yes</code>, 从节点不做任何写的操作, 保证和主节点数据一样</li>
</ul>
</li>
</ul>
<h3 id="全量复制"><a href="#全量复制" class="headerlink" title="全量复制"></a>全量复制</h3><p>Redis的主从复制是异步操作, 也就是说同步过程中, 主节点可以发生改变, redis有机制能够保证同步过程发生的改变也同步到从节点中. 也就是全量复制</p>
<p><strong>全量复制过程</strong></p>
<ul>
<li>从主节点复制, 生成rdb文件</li>
<li>redis内部会记录复制期间主节点的变化</li>
<li>复制完成后比叫主从节点的偏移量来查看主节点是否有变化, 并将变化同步到从节点中</li>
</ul>
<p><strong>全量复制开销</strong></p>
<ul>
<li>bgsave时间</li>
<li>RDB文件网络传输时间</li>
<li>从节点清空时间</li>
<li>从节点加载RDB文件时间</li>
<li>可能的AOF重写时间</li>
</ul>
<h3 id="部分复制"><a href="#部分复制" class="headerlink" title="部分复制"></a>部分复制</h3><p>如果全量复制期间发生网络抖动等原因导致复制到从节点数据丢失或不完整, 再次进行全量复制显然是不合理的, 因为前面看到全量复制开销很大. 这时就有了部分复制</p>
<p>在全量复制开始时, 主节点会进行复制缓冲区命令. 当网络抖动结束后, 从节点再次尝试连接主节点, 并将自己的偏移量offset和runid发送给主节点<br>如果从节点的偏移量和主节点的偏移量小于某值(缓冲区内), 就会发生部分复制, 从从节点的offset开始复制, 发送给从节点.<br>否则就全量复制.</p>
<h3 id="故障处理"><a href="#故障处理" class="headerlink" title="故障处理"></a>故障处理</h3><ul>
<li>slave故障<ul>
<li>使用别的slave暂时代替</li>
</ul>
</li>
<li>master故障<ul>
<li>让slave成为新的master</li>
</ul>
</li>
</ul>
<h3 id="主从复制常见问题"><a href="#主从复制常见问题" class="headerlink" title="主从复制常见问题"></a>主从复制常见问题</h3><ul>
<li>读写分离<ul>
<li>用master写, 读的流量分摊到各个slave</li>
<li>可能问题:<ul>
<li>复制数据延迟</li>
<li>读到过期数据</li>
<li>从节点故障</li>
</ul>
</li>
</ul>
</li>
<li>配置不一致<ul>
<li>如maxmamory不一致导致数据丢失</li>
<li>如数据结构优化参数导致内存不一致</li>
</ul>
</li>
<li>规避全量复制<ul>
<li>第一次全量复制不可避免<ul>
<li>小主节点, 或者低峰值的时候进行</li>
</ul>
</li>
<li>节点运行ID不匹配<ul>
<li>主节点重启(运行ID变化)</li>
<li>故障转移</li>
</ul>
</li>
<li>复制积压缓冲区不足<ul>
<li>部分复制</li>
<li>增大复制换缓冲区配置<code>rel_backlog_size</code></li>
</ul>
</li>
</ul>
</li>
<li>复制风暴(主节点挂载了很多子节点, 当主节点宕机重启后, ID发生变化, 所有从节点都进行一次全量复制)<ul>
<li>单节点复制风暴<ul>
<li>分摊从节点到从节点的链式结构, 可以减轻主节点的压力, 当时结果复杂, 维护难度加大</li>
</ul>
</li>
<li>单机复制风暴, 单机器上都是主节点<ul>
<li>主节点分散多机器</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="Redis-Sentinel"><a href="#Redis-Sentinel" class="headerlink" title="Redis Sentinel"></a>Redis Sentinel</h2><p>Redis Sentinel是redis的一个高可用实现, 解决故障节点的检测和完美迁移的一个客户端</p>
<h3 id="Redis-Sentinel框架"><a href="#Redis-Sentinel框架" class="headerlink" title="Redis Sentinel框架"></a>Redis Sentinel框架</h3><p>sentinel会对每个redis进行监控, 用户使用redis不再是直接使用redis, 而是通过sentinel间接使用redis.<br>当发生故障进行故障转移后, 客户端不再关心哪个redis成为了master, 只用关心sentinel告诉我们的结果. </p>
<p>Redis Sentinel其实是个sentinel集合, sentinel实现故障转移的过程如下:</p>
<ul>
<li>多个sentinel发现并确认master有问题</li>
<li>选举出一个sentinel作为领导</li>
<li>选出一个slave作为master</li>
<li>通知其余slave成为新master的slave</li>
<li>告知客户端主从变化</li>
<li>当老的master复活后, 使其成为新master的slave</li>
</ul>
<p>Redis Sentinel可以监控多套master和slave, 使用master-name的配置作为标识和说明</p>
<h3 id="Redis-Sentinel原理"><a href="#Redis-Sentinel原理" class="headerlink" title="Redis Sentinel原理"></a>Redis Sentinel原理</h3><p>Redis Sentinel内部会运行三个定时任务</p>
<ul>
<li>每10秒每个sentinal对master和slave执行info<ul>
<li>发现slave节点</li>
<li>确认主从关系</li>
</ul>
</li>
<li>每2秒每个sentinel通过master节点的channel交换信息(发布订阅)<ul>
<li>通过 __sentinel__:hello频道交互</li>
<li>交互节点的”看法”(失败判定)和自身信息</li>
</ul>
</li>
<li>每1秒每个sentinel对其他sentinel和redis执行ping<ul>
<li>心跳检测, 失败判定</li>
</ul>
</li>
</ul>
<h4 id="主观下线和客观下线"><a href="#主观下线和客观下线" class="headerlink" title="主观下线和客观下线"></a>主观下线和客观下线</h4><p>每个sentinel对节点的判定可能不同(受网络影响等等), 所以一个节点的判定是不真实的, 根据单个节点进行的主观下线也是不合理的.<br>所以下线操作要根据多个节点投票来决定, 称之为客观下线.</p>
<p><code>sentinel monitor &lt;masterName&gt; &lt;ip&gt; &lt;port&gt; &lt;quorum&gt;</code>quorum就是投票通过的判定, 多为奇数</p>
<h4 id="领导者选举"><a href="#领导者选举" class="headerlink" title="领导者选举"></a>领导者选举</h4><p>领导者选举使用raft算法</p>
<ul>
<li>选举: 通过sentinel is-master-down-by-addr命令都希望成为领导者<ul>
<li>每个主管下线的sentinel节点向其他sentinel节点发送该命令, 希望将它设置为领导者</li>
<li>收到命令的sentinel如果没有同意过其他sentinel节点发送的命令, 就会同意该请求, 否则拒绝</li>
<li>如果当前sentinal节点发现自己的票数超过sentinel集合半数且超过quorum, 则它成为领导者</li>
<li>如果此过程有多个sentinel节点成为领导者, 那么将等待一段时间再次进行选举</li>
</ul>
</li>
</ul>
<h4 id="故障转移-sentinel领导者完成"><a href="#故障转移-sentinel领导者完成" class="headerlink" title="故障转移(sentinel领导者完成)"></a>故障转移(sentinel领导者完成)</h4><ul>
<li>从slave节点选出”合适的”节点作为新的master</li>
<li>对上面的slave节点执行<code>slaveof no one</code>让其成为master</li>
<li>向剩余的slave节点发送命令, 让它们成为新的master节点的slave, 复制规则和<code>parallel-syncs</code>参数有关</li>
<li>更新对原来master节点的配置为slave, 并保持这对其”关注”, 当其恢复后命令它去复制新的master节点</li>
</ul>
<p><strong>slave节点的选择</strong> </p>
<ul>
<li>选择<code>slave-priority</code>(节点优先级)最高的slave节点, 如果存在则返回, 不存在进行下一步选择<ul>
<li>默认优先级的一样的, 可以根据机器配置高低手动配置</li>
</ul>
</li>
<li>选择复制偏移量最大的slave节点(越大说明越接近主节点, 越完整), 不存在则进行下一步</li>
<li>选择runId最小的slave节点</li>
</ul>
<h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><ul>
<li>配置开启主节点</li>
<li>配置开启sentinel监控主节点(<strong>sentinel是特殊的redis</strong>)</li>
<li>实际应该用多机器</li>
<li>详细配置节点</li>
</ul>
<p>配置开启主从节点</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">port $&#123;port&#125;</span><br><span class="line">daemonize yes</span><br><span class="line">pidfile &#x2F;path&#x2F;to&#x2F;pidfile.pid</span><br><span class="line">logfile &quot;logfile.log&quot;</span><br><span class="line">dir &quot;&#x2F;dir&#x2F;to&quot;</span><br><span class="line"></span><br><span class="line"># 从节点</span><br><span class="line">slaveof ip port</span><br></pre></td></tr></table></figure>

<p>sentinel主要配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">port $&#123;port&#125;</span><br><span class="line">daemonize yes</span><br><span class="line">dir &quot;path&#x2F;to&#x2F;dir&quot;</span><br><span class="line">logfile &quot;$&#123;port&#125;.log&quot;</span><br><span class="line"></span><br><span class="line">sentinel monitor master-name ip port 2  # 自定一个mastername, 2表示当两个sentinel认为这个主节点出问题时, 故障转移</span><br><span class="line">sentinel down-after-milliseconds master-name 30000  # 类似于ping的时间</span><br><span class="line">sentinel parallel-syncs master-name 1  # 允许老slave同时对新master进行复制的个数</span><br><span class="line">sentinel failover-timeout master-name 180000</span><br></pre></td></tr></table></figure>

<p>启动Redis Sentinel</p>
<ul>
<li><code>redis-sentinel [config file]</code></li>
<li>或者<code>redis-server --sentinel [config file]</code></li>
</ul>
<h3 id="客户端结合sentinel实现高可用"><a href="#客户端结合sentinel实现高可用" class="headerlink" title="客户端结合sentinel实现高可用"></a>客户端结合sentinel实现高可用</h3><p>sentinel实现的高可用, 如果客户端没有实现高可用, 对sentinel的感知不高, 那也并不是高可用的</p>
<ul>
<li>客户端遍历sentinel节点集合, 获取一个可用的sentinel节点</li>
<li>通过sentinal获取master节点<code>sentinel get-master-addr-by-name master-name</code></li>
<li><code>role</code>或者<code>role replication</code>验证是否是真的master节点</li>
<li>当master节点发生变化, 通知客户端(发布订阅的模式)</li>
</ul>
<p>各语言API有所不同</p>
<h4 id="读写分离"><a href="#读写分离" class="headerlink" title="读写分离"></a>读写分离</h4><p>主节点挂掉后, sentinel服务可以方便的帮我们完成故障迁移. 如果slave节点挂掉后, 我们应该通过一定的手段让客户端迁移, 不让故障节点影响到客户端.</p>
<p>三个迁移判断:</p>
<ul>
<li>切换主节点时(从节点晋升为主节点)</li>
<li>写换从节点时(主节点下降为从节点)</li>
<li>主观下线时</li>
</ul>
<p>客户端配合sentinel实现起来还是比较复杂的, 后面的集群更适合进行这样的读写分离</p>
<h3 id="主动下线"><a href="#主动下线" class="headerlink" title="主动下线"></a>主动下线</h3><p>有时候设备更新等原因, 需要关闭/重启/迁移服务器等等. 运维人员可以手动下线服务器的节点.<br><code>sentinel failover &lt;masterName&gt;</code> 手动让主机点下线, 然后sentinel会让它故障转移.</p>
<h3 id="节点上线"><a href="#节点上线" class="headerlink" title="节点上线"></a>节点上线</h3><ul>
<li>主节点: <code>sentinel failover &lt;masterName&gt;</code> 让重启的主节点重新成为主节点</li>
<li>从节点: <code>slaveof</code>即可, sentinel节点可以感知</li>
<li>sentinel节点: 参考其他sentinel节点启动即可, 订阅发布</li>
</ul>
<h2 id="Redis-Cluster"><a href="#Redis-Cluster" class="headerlink" title="Redis Cluster"></a>Redis Cluster</h2><h3 id="呼唤集群"><a href="#呼唤集群" class="headerlink" title="呼唤集群"></a>呼唤集群</h3><p>为什么需要呼唤</p>
<ul>
<li>并发量: OPS<ul>
<li>Redis官方数据每秒可以执行10万行, 但是如果业务要求100万/每秒呢</li>
</ul>
</li>
<li>数据量<ul>
<li>一般的计算机内存16~256G, 但是如果业务要求500G呢</li>
</ul>
</li>
<li>流量<ul>
<li>单机流量是千兆网卡, 但是业务要求万兆呢</li>
</ul>
</li>
</ul>
<p>分布式就是结局这些问题的好方法, 集群就相当于机柜. 规模化需求.</p>
<h3 id="数据分布"><a href="#数据分布" class="headerlink" title="数据分布"></a>数据分布</h3><p>全量分布 =&gt; 一定的分区规则 =&gt; 子集N</p>
<ul>
<li>顺序分区<ul>
<li>数据分散度易倾斜</li>
<li>键值业务相关<ul>
<li>如按日期的顺序分区</li>
</ul>
</li>
<li>可顺序访问</li>
<li>不支持批量操作</li>
</ul>
</li>
<li>哈希分区<ul>
<li>数据分散度高</li>
<li>键值与业务无关</li>
<li>无法顺序访问</li>
<li>支持批量操作</li>
</ul>
</li>
</ul>
<h4 id="哈希分布"><a href="#哈希分布" class="headerlink" title="哈希分布"></a>哈希分布</h4><ul>
<li>节点取余分区<ul>
<li>扩容时, 迁移率高</li>
<li>使用多倍扩容可以优化</li>
</ul>
</li>
<li>一致性哈希分区<ul>
<li>让节点分布在一个token环上(首尾相连的数组), 举行哈希运算后先后检索</li>
<li>节点伸缩时, 只影响附近的节点, 迁移量较小</li>
<li>伸缩时建议翻倍伸缩, 保证负载均衡</li>
</ul>
</li>
<li>虚拟槽分区<ul>
<li>Redis Cluster的分区方式, Redis Cluster有16384个节点, 开槽是对16384进行平均</li>
<li>按一定的范围划分虚拟槽, 每个节点对应一个槽, 任取一个节点计算key哈希运算的结果, 如果结果是是自己管辖的范围, 则通过redis cluster的节点通信告知目标节点</li>
</ul>
</li>
</ul>
<h3 id="集群搭建"><a href="#集群搭建" class="headerlink" title="集群搭建"></a>集群搭建</h3><p>Redis Cluster架构</p>
<ul>
<li>节点<ul>
<li><code>cluster-enabled: yes</code>以集群模式启动节点</li>
</ul>
</li>
<li>meet<ul>
<li>有一个节点向其他节点发送”meet”, 节点收到后回复</li>
<li>内部机制让于同一个节点”meet”的节点们能互通</li>
</ul>
</li>
<li>指派槽<ul>
<li>负载均衡</li>
</ul>
</li>
<li>复制<ul>
<li>保证高可用</li>
</ul>
</li>
</ul>
<h3 id="安装-1"><a href="#安装-1" class="headerlink" title="安装"></a>安装</h3><h4 id="原生命令安装"><a href="#原生命令安装" class="headerlink" title="原生命令安装"></a>原生命令安装</h4><ul>
<li>配置开启节点<ul>
<li><code>port ${port}</code></li>
<li><code>daemonize yes</code></li>
<li><code>dir &quot;/path/to/&quot;</code></li>
<li><code>dbfilename &quot;dump-${port}.rdb&quot;</code></li>
<li><code>logfile &quot;${port}.log&quot;</code></li>
<li><code>cluster-enabled yes</code>  是cluser节点</li>
<li><code>cluster-config-file nodes-${port}.conf</code> 为当前节点单独选择配置文件</li>
<li><code>cluster-node-timeout 15000</code></li>
<li><code>cluster-require-full-coverage yes</code>  当集群中所有节点可以用时才提供服务, 默认是yes, 不符合高可用</li>
</ul>
</li>
<li>节点握手: meet<ul>
<li><code>cluster meet ip port</code></li>
</ul>
</li>
<li>指派槽<ul>
<li><code>cluster addslots slot [slot...]</code></li>
</ul>
</li>
<li>主从关系分配实现高可用<ul>
<li><code>cluster replicate node-id</code> node-id是值集群节点的id, 不是runid</li>
</ul>
</li>
</ul>
<h4 id="使用Ruby安装脚本"><a href="#使用Ruby安装脚本" class="headerlink" title="使用Ruby安装脚本"></a>使用Ruby安装脚本</h4><h3 id="集群伸缩"><a href="#集群伸缩" class="headerlink" title="集群伸缩"></a>集群伸缩</h3><p>集群搭建 = 虚拟槽和数据在节点之间移动</p>
<h4 id="集群扩容"><a href="#集群扩容" class="headerlink" title="集群扩容"></a>集群扩容</h4><ul>
<li>准备新集群节点</li>
<li>加入集群<ul>
<li><code>cluster meet ip port</code></li>
</ul>
</li>
<li>迁移槽和数据<ul>
<li>迁移计划: 槽的规划</li>
<li>迁移数据<ul>
<li>对目标节点发送: <code>cluster setslot {slot} importing {sourceNodeId}</code>, 让目标节点准备导入槽的数据</li>
<li>对源节点发送: <code>cluster setslot {slot} migraing {targetNodeId}</code>, 让源节点准备迁出槽数据 </li>
<li>源节点循环执行: <code>cluster getkeysinslot {slot} {count}</code>, 每次获取count个属于槽的键</li>
<li>在源节点上执行: <code>migrate {targetIp} {targetPort} key 0 {timeout}</code>, 把指定key迁移, 0是值数据库0, redis中只有db0</li>
<li>重复执行3-4直到槽下所有的键数据迁移到目标节点</li>
<li>向集群内所有主节点发送<code>cluster setslot {slot} node {targetNodeId}</code>, 通知槽分配给目标节点</li>
</ul>
</li>
<li>添加从节点</li>
</ul>
</li>
</ul>
<h4 id="集群缩容"><a href="#集群缩容" class="headerlink" title="集群缩容"></a>集群缩容</h4><ul>
<li>下线迁移槽<ul>
<li>因为节点是互通的, 下线一个节点就要让所有节点忘记它</li>
</ul>
</li>
<li>忘记节点<ul>
<li><code>redis-cli cluster forget {downNodeId}</code>, 有效时间60s, 60秒, 如果有一个节点没有忘记downNodeId的话就会恢复</li>
</ul>
</li>
<li>关闭节点</li>
</ul>
<h3 id="客户端路由"><a href="#客户端路由" class="headerlink" title="客户端路由"></a>客户端路由</h3><h4 id="moved重定向"><a href="#moved重定向" class="headerlink" title="moved重定向"></a>moved重定向</h4><p>客户端向某个发送键命令, 哈希计算后发现这条命令的的槽是当前节点控制的, 则执行. 否则回复moved异常. 包含槽 ip:port<br>客户端收到moved异常后, 再(如果不是集群模式的话, -c)手动向对应节点发送信息.</p>
<h4 id="ask重定向"><a href="#ask重定向" class="headerlink" title="ask重定向"></a>ask重定向</h4><p>因为槽迁移的比较慢的, 如果发送命令后返回了moved异常, 但当我们对目标节点再次发送命令后, 发现节点已经迁移了. 这就比较尴尬.</p>
<p>ask重定向就能解决这一问题. 客户端发送键命令到源节点, 但是发现节点此时正在做槽迁移, 那就会返回ask转向异常.<br>当我们收到ask转向异常后, 我们向目标节点发送<code>Asking</code>命令, 再发送要执行的命令</p>
<ul>
<li>moved: 槽在确定节点中</li>
<li>ask: 槽在迁移中, 不确定在哪个节点</li>
</ul>
<h4 id="smart客户端-追求性能"><a href="#smart客户端-追求性能" class="headerlink" title="smart客户端: 追求性能"></a>smart客户端: 追求性能</h4><h3 id="批量操作"><a href="#批量操作" class="headerlink" title="批量操作"></a>批量操作</h3><p>当分布到多个节点后要怎么一次对所有节点进行操作呢?</p>
<ul>
<li>串行mget<ul>
<li>效率底</li>
<li>n次网络时间</li>
</ul>
</li>
<li>串行IO<ul>
<li>在本地算出key的槽, 然后根据redis的的分组, 把key集中到一起再去访问redis对应的node(pipline)</li>
<li>nodes次网络时间</li>
</ul>
</li>
<li>并行IO<ul>
<li>多线程地执行串行IO</li>
</ul>
</li>
<li>hash_tag<ul>
<li>性能最高但读写增加tag维护成本, tag分布容易倾斜</li>
</ul>
</li>
</ul>
<h3 id="Redis-Cluster的故障转移"><a href="#Redis-Cluster的故障转移" class="headerlink" title="Redis Cluster的故障转移"></a>Redis Cluster的故障转移</h3><h4 id="故障发现"><a href="#故障发现" class="headerlink" title="故障发现"></a>故障发现</h4><p>节点间ping/pong, 原理类似sentinel</p>
<ul>
<li>主管下线</li>
<li>客观下线</li>
</ul>
<h4 id="故障恢复"><a href="#故障恢复" class="headerlink" title="故障恢复"></a>故障恢复</h4><ul>
<li>检查资格<ul>
<li>检查slave成为主节点的资格</li>
</ul>
</li>
<li>选举</li>
<li>替换主节点</li>
</ul>
<h2 id="缓存的设计"><a href="#缓存的设计" class="headerlink" title="缓存的设计"></a>缓存的设计</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">request-&gt;cache: request</span><br><span class="line">cache--&gt;request: response</span><br><span class="line">cache-&gt;storage: request</span><br><span class="line">storage-&gt;cache: response</span><br><span class="line">storage--&gt;request: response</span><br></pre></td></tr></table></figure>

<ul>
<li>收益<ul>
<li>加速读写</li>
<li>降低后端负担<ul>
<li>如降低后端MySQL负担</li>
</ul>
</li>
</ul>
</li>
<li>成本<ul>
<li>数据不一致: 缓存层和数据层有时间窗口不一致, 和更新策略有关<ul>
<li>如数据库更新了, 缓存没更新</li>
</ul>
</li>
<li>代码维护成本</li>
<li>运维成本</li>
</ul>
</li>
</ul>
<h3 id="缓存更新策略"><a href="#缓存更新策略" class="headerlink" title="缓存更新策略"></a>缓存更新策略</h3><ul>
<li>LRU/LFU/FIFO算法剔除: 如maxmemory-policy</li>
<li>超时剔除: 如expire</li>
<li>主动更新: 开发控制生命周期</li>
</ul>
<p>随机应变</p>
<table>
<thead>
<tr>
<th>策略</th>
<th>一致性</th>
<th>维护成本</th>
</tr>
</thead>
<tbody><tr>
<td>LRU/LFU/FIFO算法剔除</td>
<td>最差</td>
<td>低</td>
</tr>
<tr>
<td>超时剔除</td>
<td>较差</td>
<td>低</td>
</tr>
<tr>
<td>主动更新</td>
<td>强</td>
<td>高</td>
</tr>
</tbody></table>
<p>建议</p>
<ul>
<li>低一致性: 最大内存和淘汰策略</li>
<li>高一致性: 超时剔除和主动更新结合, 最大内存和淘汰策略兜底</li>
</ul>
<h3 id="缓存粒度控制"><a href="#缓存粒度控制" class="headerlink" title="缓存粒度控制"></a>缓存粒度控制</h3><p>三个角度</p>
<ul>
<li>通用性: 全量属性更好</li>
<li>占用空间: 部分属性更好</li>
<li>代码维护: 表面上全量属性更好</li>
</ul>
<h3 id="缓存穿透"><a href="#缓存穿透" class="headerlink" title="缓存穿透"></a>缓存穿透</h3><p>当大量请求不命中时, 及请求的数据不存在, 那缓存相当于没有作用, 还得每次从存储层读取遍历, 增大存储曾负载</p>
<p>原因</p>
<ul>
<li>业务代码自身问题</li>
<li>恶意攻击, 爬虫等</li>
</ul>
<p>如何发现</p>
<ul>
<li>业务的相应时间</li>
<li>业务本身问题</li>
<li>相关指标</li>
</ul>
<p>解决方法</p>
<ul>
<li>缓存空对象<ul>
<li>两个问题<ul>
<li>需要更多的键</li>
<li>缓存层和存储层”短期”不一致</li>
</ul>
</li>
</ul>
</li>
<li>布隆过滤器拦截<ul>
<li>用较小的内存实现过滤</li>
<li>也要根据实际情况使用</li>
</ul>
</li>
</ul>
<h3 id="无底洞问题"><a href="#无底洞问题" class="headerlink" title="无底洞问题"></a>无底洞问题</h3><p>加机器反而性能下降. 如当节点个数很多时, 客户端向节点发送批量操作命令(如mget), 那么这么多的节点就会导致网络时间非超明显</p>
<p>问题关键点</p>
<ul>
<li>更多的机器!=更高的性能</li>
<li>批量接口需求(mget, mset等)</li>
<li>数据增长与水平扩展需求</li>
</ul>
<p>优化IO的几种方法</p>
<ul>
<li>命令本身优化: 如慢查询keys, hgetall bigkey</li>
<li>减少网络通信次数<ul>
<li>数据库不同而不同</li>
</ul>
</li>
<li>降低接入成本: 如客户端长连接/连接池, NIO等</li>
</ul>
<h3 id="热点key重建"><a href="#热点key重建" class="headerlink" title="热点key重建"></a>热点key重建</h3><p>缓存重建的时间到了, 但这时有个热点key, 热点key性能消耗很大, 会导致重建的时间变长</p>
<p>三个目标:</p>
<ul>
<li>减少重建缓存的次数<ul>
<li>由于网络延迟等原因, 当地一个请求发现需要重建缓存时, 进行重建换成, 但这个热点key会有很多请求在统一时间发送, 会有很多重建缓存的命令</li>
</ul>
</li>
<li>数据尽可能一致</li>
<li>减少潜在风险</li>
</ul>
<h4 id="解决思路"><a href="#解决思路" class="headerlink" title="解决思路"></a>解决思路</h4><ul>
<li>互斥锁(mutex key)<ul>
<li>重建一次只能接收一个命令, 其他重建命令要等待重建完成<ul>
<li>但是会存在等待时间, 浪费内存</li>
<li>代码复杂度增加</li>
<li>存在锁死风险</li>
</ul>
</li>
</ul>
</li>
<li>永不过期<ul>
<li>缓存上不设置过期时间, 但不代表它不会更新</li>
<li>功能层面(逻辑过期), 会使用一个线程后台的更新缓存, 这样就不存在等待时间的问题<ul>
<li>但是这样会导致数据不一致</li>
<li>逻辑过期时间维护成本和内存成本增加</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="Redis云平台CacheCloud"><a href="#Redis云平台CacheCloud" class="headerlink" title="Redis云平台CacheCloud"></a>Redis云平台CacheCloud</h2><p>当节点数量很多时, 运维就会遇到问题.</p>
<ul>
<li>发布构建繁琐, 私搭乱搭</li>
<li>节点&amp;机器等运维成本</li>
<li>监控报警初级</li>
</ul>
<p>可以自己写脚本, 当然网上也有很多开源项目</p>
<p>CacheCloud开源项目能够:</p>
<ul>
<li>一键开启Redis</li>
<li>机器, 应用, 实例监控和报警</li>
<li>客户端: 透明使用, 性能上报</li>
<li>可视化运维</li>
<li>已存在Redis直接接入和数据迁移</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/03/02/universe/typescript/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/03/02/universe/typescript/" itemprop="url">TypeScript</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-03-02T00:00:00+08:00">
                2020-03-02
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="TypeScript"><a href="#TypeScript" class="headerlink" title="TypeScript"></a>TypeScript</h1><h2 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h2><p>typescript是编译型,编译成javascript(解释型).</p>
<ul>
<li>安装<ul>
<li><code>npm install -g typescript</code></li>
</ul>
</li>
<li>编译<ul>
<li><code>tsc hello.ts</code></li>
</ul>
</li>
<li>编写react时以.tsx为后缀</li>
</ul>
<h2 id="强类型"><a href="#强类型" class="headerlink" title="强类型"></a>强类型</h2><h3 id="指定类型"><a href="#指定类型" class="headerlink" title="指定类型"></a>指定类型</h3><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> str:<span class="built_in">string</span> = <span class="string">"1"</span>;</span><br><span class="line"><span class="keyword">var</span> num:<span class="built_in">number</span> = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">var</span> bool:<span class="built_in">boolean</span> = <span class="literal">true</span>;</span><br><span class="line"><span class="keyword">var</span> un:<span class="literal">undefined</span> = <span class="literal">undefined</span>;</span><br><span class="line"><span class="keyword">var</span> nil:<span class="literal">null</span> = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">var</span> a:<span class="built_in">any</span>;</span><br><span class="line">a = <span class="number">1</span>;</span><br><span class="line">a = <span class="string">"1"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> func1 = <span class="function"><span class="keyword">function</span>(<span class="params"></span>):<span class="title">void</span></span>&#123;</span><br><span class="line">     </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> func2 = <span class="function"><span class="keyword">function</span>(<span class="params"></span>):<span class="title">number</span></span>&#123;</span><br><span class="line">   <span class="keyword">return</span> <span class="number">0</span> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>没有赋值,表示是any值,以后不管怎么赋值都是any值的类型</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> a2;</span><br><span class="line">a2 = <span class="number">1</span>;</span><br><span class="line">a2 = <span class="string">"1"</span>;</span><br></pre></td></tr></table></figure>

<p>联合类型,方法只能调用类型公共的方法</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> strnum:<span class="built_in">string</span>|<span class="built_in">number</span> = <span class="string">"1"</span>;</span><br><span class="line"><span class="comment">// strnum.length() 就不行</span></span><br><span class="line">strnum.toString()</span><br></pre></td></tr></table></figure>

<h3 id="接口"><a href="#接口" class="headerlink" title="接口"></a>接口</h3><p>类似java的接口,’子类必须实现接口’</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> Inf&#123;</span><br><span class="line">    name:<span class="built_in">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> obj:Inf;</span><br><span class="line">obj = &#123;name:<span class="string">"ring"</span>&#125;  <span class="comment">// 没有赋值会报错</span></span><br></pre></td></tr></table></figure>

<p>可选属性</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> Inf&#123;</span><br><span class="line">    name:<span class="built_in">string</span>,</span><br><span class="line">    age?:<span class="built_in">number</span>  <span class="comment">// 可选类型</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> obj:Inf;</span><br><span class="line">obj = &#123;name:<span class="string">"ring"</span>&#125;</span><br></pre></td></tr></table></figure>

<p>不确定数量属性</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> Inf&#123;</span><br><span class="line">    name:<span class="built_in">string</span>,</span><br><span class="line">    age?:<span class="built_in">number</span>, <span class="comment">// 可选类型</span></span><br><span class="line">    [propName:<span class="built_in">string</span>]:<span class="built_in">any</span>  <span class="comment">// 不确定数量的propName(strng类型),他的值是any</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> obj:Inf;</span><br><span class="line">obj = &#123;name:<span class="string">"ring"</span>, age:<span class="number">10</span>, sex:man&#125;</span><br></pre></td></tr></table></figure>

<p>只读属性</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> Inf&#123;</span><br><span class="line">    name:<span class="built_in">string</span>,</span><br><span class="line">    readonly age:<span class="built_in">number</span>  <span class="comment">// 只读属性</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> obj:Inf;</span><br><span class="line">obj = &#123;name:<span class="string">"ring"</span>, age:<span class="number">10</span>, sex:man&#125;</span><br></pre></td></tr></table></figure>

<h3 id="数组"><a href="#数组" class="headerlink" title="数组"></a>数组</h3><p>类型方括号</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> arr:<span class="built_in">number</span>[] = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]</span><br><span class="line"><span class="keyword">var</span> arr2:<span class="built_in">any</span>[] = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]</span><br></pre></td></tr></table></figure>

<p>泛型定义法</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> arr:<span class="built_in">Array</span>&lt;<span class="built_in">number</span>&gt; = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]</span><br><span class="line"><span class="keyword">var</span> arr2:<span class="built_in">Array</span>&lt;<span class="built_in">any</span>&gt; = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]</span><br></pre></td></tr></table></figure>

<p>接口定义法</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> IArr&#123;</span><br><span class="line">    [index:<span class="built_in">number</span>]:<span class="built_in">number</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> arr:IArr = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment">// 类型除了是内置的类型, 还可以是接口的类型</span></span><br><span class="line"><span class="keyword">interface</span> Istate&#123;</span><br><span class="line">    name:<span class="built_in">string</span>,</span><br><span class="line">    age:<span class="built_in">number</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">interface</span> IArr&#123;</span><br><span class="line">    [index:<span class="built_in">number</span>]:Istate</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> arr:IArr = [&#123;name:<span class="string">"ring"</span>, age:<span class="number">20</span>&#125;]</span><br><span class="line"><span class="keyword">var</span> arr:<span class="built_in">Array</span>&lt;IArr&gt; = [&#123;name:<span class="string">"ring"</span>, age:<span class="number">20</span>&#125;]</span><br><span class="line"><span class="keyword">var</span> arr:Istate[] = [&#123;name:<span class="string">"ring"</span>, age:<span class="number">20</span>&#125;]</span><br></pre></td></tr></table></figure>

<h3 id="函数"><a href="#函数" class="headerlink" title="函数"></a>函数</h3><p>声明式函数</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 函数名 参数名:类型  :返回类型</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">func</span>(<span class="params">name:<span class="built_in">string</span>, age:<span class="built_in">number</span></span>):<span class="title">number</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> age</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> age:<span class="built_in">number</span> = func(<span class="string">"ring"</span>, <span class="number">20</span>)</span><br></pre></td></tr></table></figure>

<p>函数参数不确定</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">func</span>(<span class="params">name:<span class="built_in">string</span>, age:<span class="built_in">number</span>, sex?:<span class="built_in">string</span></span>):<span class="title">number</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> age</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> age:<span class="built_in">number</span> = func(<span class="string">"ring"</span>, <span class="number">20</span>, <span class="string">"man"</span>)</span><br></pre></td></tr></table></figure>

<p>参数默认值</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">func</span>(<span class="params">name:<span class="built_in">string</span>, age:<span class="built_in">number</span>, sex?:<span class="built_in">string</span>="man"</span>):<span class="title">number</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> age</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> age:<span class="built_in">number</span> = func(<span class="string">"ring"</span>, <span class="number">20</span>, <span class="string">"man"</span>)</span><br></pre></td></tr></table></figure>

<p>表达式类型函数</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> func = <span class="function"><span class="keyword">function</span>(<span class="params">name:<span class="built_in">string</span>, age:<span class="built_in">number</span></span>):<span class="title">number</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> age</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> age:<span class="built_in">number</span> = func(<span class="string">"ring"</span>, <span class="number">20</span>)</span><br></pre></td></tr></table></figure>

<p>表达式类型函数变量的约束规范</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 变量  约束  类型</span></span><br><span class="line"><span class="keyword">var</span> func:<span class="function">(<span class="params">name:<span class="built_in">string</span>, age:<span class="built_in">number</span></span>)=&gt;</span><span class="built_in">number</span> = <span class="function"><span class="keyword">function</span>(<span class="params">name:<span class="built_in">string</span>, age:<span class="built_in">number</span></span>):<span class="title">number</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> age</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> age:<span class="built_in">number</span> = func(<span class="string">"ring"</span>, <span class="number">20</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 或者使用接口</span></span><br><span class="line"><span class="keyword">interface</span> Istate&#123;</span><br><span class="line">    (name:<span class="built_in">string</span>, age:<span class="built_in">number</span>):<span class="built_in">number</span>  <span class="comment">// (参数):返回类型</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> func:Istate = <span class="function"><span class="keyword">function</span>(<span class="params">name:<span class="built_in">string</span>, age:<span class="built_in">number</span></span>):<span class="title">number</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> age</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> age:<span class="built_in">number</span> = func(<span class="string">"ring"</span>, <span class="number">20</span>)</span><br></pre></td></tr></table></figure>

<p>采用重载的方式支持联合类型的函数关系</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">func</span>(<span class="params">value:<span class="built_in">string</span></span>):<span class="title">string</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">func</span>(<span class="params">value:<span class="built_in">number</span></span>):<span class="title">number</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">func</span>(<span class="params">value:<span class="built_in">string</span>|<span class="built_in">number</span></span>)</span>&#123;  <span class="comment">// 这是上面的实现</span></span><br><span class="line">    <span class="keyword">return</span> value</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">let</span> a:<span class="built_in">number</span> = func(<span class="number">1</span>)</span><br><span class="line"><span class="keyword">let</span> b:<span class="built_in">string</span> = func(<span class="string">"1"</span>)</span><br></pre></td></tr></table></figure>

<h3 id="类型断言"><a href="#类型断言" class="headerlink" title="类型断言"></a>类型断言</h3><p>在联合类型的情况下, 调用的函数要是共有的函数, 不然会报错, 所以需要进行断言</p>
<p>&lt;类型&gt;值 或 值as类型</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">func</span>(<span class="params">name:<span class="built_in">string</span>|<span class="built_in">number</span></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (&lt;<span class="built_in">string</span>&gt;name).length()</span><br><span class="line">    <span class="comment">// 或者return (name as string).length()</span></span><br><span class="line">    <span class="comment">// 只能转换成联合类型中存在的类型</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// !! jsx/tsx中必须采用后一种 !!</span></span><br></pre></td></tr></table></figure>

<h3 id="类型别名"><a href="#类型别名" class="headerlink" title="类型别名"></a>类型别名</h3><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> strtype = <span class="built_in">string</span>|<span class="built_in">number</span>;</span><br><span class="line"><span class="keyword">var</span> str:strtype = <span class="string">"10"</span></span><br><span class="line">str = <span class="number">10</span></span><br></pre></td></tr></table></figure>

<p>对于接口</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> muchType1&#123;</span><br><span class="line">    name:<span class="built_in">string</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">interface</span> muchType2&#123;</span><br><span class="line">    age:<span class="built_in">number</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> muchType = muchType1|muchType2</span><br><span class="line"><span class="keyword">var</span> obj1:muchType = &#123;name:<span class="string">"ring"</span>&#125;</span><br><span class="line"><span class="keyword">var</span> obj2:muchType = &#123;age:<span class="number">1</span>&#125;</span><br><span class="line"><span class="keyword">var</span> obj3:muchType = &#123;name:<span class="string">"ring"</span>, age:<span class="number">1</span>&#125;  <span class="comment">// 一种或多种或全部</span></span><br></pre></td></tr></table></figure>

<p>限制字符串的选择</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> sex = <span class="string">"man"</span>|<span class="string">"woman"</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">func</span>(<span class="params">s:sex</span>):<span class="title">string</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> s</span><br><span class="line">&#125;</span><br><span class="line">func(<span class="string">"man"</span>)</span><br><span class="line"><span class="comment">// func("an") 就不行</span></span><br></pre></td></tr></table></figure>

<h3 id="枚举"><a href="#枚举" class="headerlink" title="枚举"></a>枚举</h3><p>使用枚举可以定义一些有名字的数字常量</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">enum</span> Days&#123;</span><br><span class="line">    Sun,  <span class="comment">// 默认第一个取值为0</span></span><br><span class="line">    Mon,  <span class="comment">// 后面的一次累加</span></span><br><span class="line">    Tue,</span><br><span class="line">    Wed,</span><br><span class="line">    Thu,</span><br><span class="line">    Fri,</span><br><span class="line">    Sat,</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">console</span>.log(Days.Sun)</span><br></pre></td></tr></table></figure>

<p>typescript枚举出来会自动赋值外, 同时会对枚举值到枚举名的反向映射, 就是变成了双向映射</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ts编译成js后的结果</span></span><br><span class="line"><span class="comment">// 即Days[0] = "Sun"</span></span><br><span class="line"><span class="keyword">var</span> Days;</span><br><span class="line">(<span class="function"><span class="keyword">function</span> (<span class="params">Days</span>) </span>&#123;</span><br><span class="line">    Days[Days[<span class="string">"Sun"</span>] = <span class="number">0</span>] = <span class="string">"Sun"</span>;</span><br><span class="line">    Days[Days[<span class="string">"Mon"</span>] = <span class="number">1</span>] = <span class="string">"Mon"</span>;</span><br><span class="line">    Days[Days[<span class="string">"Tue"</span>] = <span class="number">2</span>] = <span class="string">"Tue"</span>;</span><br><span class="line">    Days[Days[<span class="string">"Wed"</span>] = <span class="number">3</span>] = <span class="string">"Wed"</span>;</span><br><span class="line">    Days[Days[<span class="string">"Thu"</span>] = <span class="number">4</span>] = <span class="string">"Thu"</span>;</span><br><span class="line">    Days[Days[<span class="string">"Fri"</span>] = <span class="number">5</span>] = <span class="string">"Fri"</span>;</span><br><span class="line">    Days[Days[<span class="string">"Sat"</span>] = <span class="number">6</span>] = <span class="string">"Sat"</span>;</span><br><span class="line">&#125;)(Days || (Days = &#123;&#125;));</span><br><span class="line"><span class="built_in">console</span>.log(Days.Sun);</span><br></pre></td></tr></table></figure>

<h3 id="类的修饰符"><a href="#类的修饰符" class="headerlink" title="类的修饰符"></a>类的修饰符</h3><p>public private protected</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> Person&#123;</span><br><span class="line">    name = <span class="string">"ring"</span>,</span><br><span class="line">    <span class="keyword">private</span> age = <span class="number">20</span>,</span><br><span class="line">    <span class="keyword">protected</span> say()&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"halo"</span>)</span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 没有修饰的话, 类中的属性后方法默认是public</span></span><br><span class="line"><span class="comment">// private 属性只能在类中被访问</span></span><br><span class="line"><span class="comment">// protected 只能在类及其子类中访问</span></span><br></pre></td></tr></table></figure>

<p>类的继承</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> Child <span class="keyword">extends</span> Person&#123;</span><br><span class="line">    callParent()&#123;</span><br><span class="line">        <span class="keyword">super</span>.say()  <span class="comment">// super能拿到父类的对象, 所以能访问父类公开的属性和方法</span></span><br><span class="line">        <span class="comment">// 类中也能访问父类protected的方法, 类外就不行</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>静态方法, 可以通过类名调用</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> Child <span class="keyword">extends</span> Person&#123;</span><br><span class="line">    callParent()&#123;</span><br><span class="line">        <span class="keyword">super</span>.say()  </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">static</span> test()&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"halo"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(Child.test())  <span class="comment">// 但在静态方法中不可以使用this</span></span><br></pre></td></tr></table></figure>

<h3 id="泛型"><a href="#泛型" class="headerlink" title="泛型"></a>泛型</h3><p>泛型是指在定义函数, 接口或类的时候, 不预先指定具体类型, 而在使用的时候再指定类型的一种特性.<br>也可以帮助我们限定约束规范</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 用T来统一类型, T可以是任何名字</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">func</span>&lt;<span class="title">T</span>&gt;(<span class="params">len:<span class="built_in">number</span>, value:&lt;T&gt;</span>):<span class="title">Array</span>&lt;<span class="title">T</span>&gt;</span>&#123;</span><br><span class="line">    <span class="keyword">let</span> arr = []</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">var</span> i=<span class="number">0</span>;i&lt;len;<span class="number">1</span>++)&#123;</span><br><span class="line">        arr[i] = value</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> arr;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> strArry: <span class="built_in">string</span>[] = func&lt;<span class="built_in">string</span>&gt;(<span class="number">3</span>, <span class="string">'1'</span>)  <span class="comment">// 制定类型为string</span></span><br><span class="line"><span class="keyword">var</span> numArry: <span class="built_in">number</span>[] = func(<span class="number">3</span>, <span class="number">1</span>)  <span class="comment">// 右边也可以不指定类型, 因为左边要求就收的是number, 所以它会反推</span></span><br></pre></td></tr></table></figure>

<p>接口采用泛型</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> Istate&#123;</span><br><span class="line">    &lt;T&gt;(name:<span class="built_in">string</span>, value:T):<span class="built_in">Array</span>&lt;T&gt;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> func:Istate;</span><br><span class="line"><span class="comment">// 接口约束函数返回值</span></span><br><span class="line">func = <span class="function"><span class="keyword">function</span>&lt;<span class="title">T</span>&gt;(<span class="params">name:<span class="built_in">string</span>, value:T</span>):<span class="title">Array</span>&lt;<span class="title">T</span>&gt;</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> []</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 调用时指定类型</span></span><br><span class="line"><span class="keyword">var</span> strArry:<span class="built_in">string</span> [] = func(<span class="string">"ring"</span>, <span class="string">"2020"</span>)  <span class="comment">// 2020就指定了类型是string</span></span><br><span class="line"><span class="keyword">var</span> numArry:<span class="built_in">number</span> [] = func(<span class="string">"ring"</span>, <span class="number">2020</span>)  <span class="comment">// 同理</span></span><br></pre></td></tr></table></figure>










          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/02/28/universe/python/python_level_up/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/02/28/universe/python/python_level_up/" itemprop="url">Python补完计划</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-02-28T00:00:00+08:00">
                2020-02-28
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="python提高"><a href="#python提高" class="headerlink" title="python提高"></a>python提高</h2><h3 id="GIL-全局解释器锁"><a href="#GIL-全局解释器锁" class="headerlink" title="GIL(全局解释器锁)"></a>GIL(全局解释器锁)</h3><p>保证多线程程序同一时间只有一个线程在执行。多个线程先强锁。</p>
<p>c语言写的python解释器存在GIL。</p>
<p>一面试题</p>
<blockquote>
<p>描述python GIL的概念，以及它对python多线程的影响。编写一个多线程抓取网页的程序，并阐明多线程抓取程序是否比单线程性能有提升，并解释原因</p>
</blockquote>
<p>参考答案</p>
<blockquote>
<ul>
<li><ol>
<li>python语言和GIL没有半毛钱关系。仅仅是由于历史原因在Cpython解释器，难以移除GIL</li>
</ol>
</li>
<li><ol start="2">
<li>GIL：全局解释器锁。每个线程在执行的过程都需要先抢GIL，保证同一时刻只有一个线程可以执行</li>
</ol>
</li>
<li><ol start="3">
<li>线程释放GIL锁的情况：在IO操作等可能会引起阻塞的system call之前，可以暂时释放GIL，但在执行完毕后，必须重新获取GIL python3.x使用计时器(执行时间到达阀值后，当前线程释放GIL)或python2.x的tickels计数到100</li>
</ol>
</li>
<li><ol start="4">
<li>python使用多进程可以利用多核CPU资源</li>
</ol>
</li>
<li><ol start="5">
<li>多线程爬取性能有提升，因为遇到IO阻塞(如网络)会自动释放GIL锁</li>
</ol>
</li>
</ul>
</blockquote>
<p>IO密集型程序适合用多线程</p>
<h3 id="深拷贝、浅拷贝"><a href="#深拷贝、浅拷贝" class="headerlink" title="深拷贝、浅拷贝"></a>深拷贝、浅拷贝</h3><p>赋值语句在python中一般都是引用</p>
<ul>
<li>深拷贝<code>copy.deepcopy</code><ul>
<li><code>import copy</code></li>
<li><code>b = copy.deepcopy(a)</code></li>
<li><code>id(a) != id(b)</code></li>
<li>如果拷贝的是元祖，且元祖里有可变的数据，设元祖a，则deepcopy结果<code>id(a)!=id(b)</code></li>
</ul>
</li>
<li>浅拷贝<code>copy.copy</code><ul>
<li><code>import copy</code></li>
<li><code>b = copy.copy(a)</code></li>
<li><code>id(a) != id(b)</code></li>
<li>但是如果拷贝的是元祖，且元祖里只有普通数据(不可变的)，设元祖a，则copy结果<code>id(a)==id(b)</code><ul>
<li>因为元祖是不可变类型，增删改都没用所以拷贝有什么用，所有就不拷贝</li>
</ul>
</li>
</ul>
</li>
<li>切片也是浅拷贝</li>
<li>字典<code>key: value</code>，value是指向别处的引用</li>
<li>浅拷贝和深拷贝的区别  <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">a = [<span class="number">1</span>, <span class="number">2</span>]</span><br><span class="line">b = [<span class="number">3</span>, <span class="number">4</span>]</span><br><span class="line">c = [a, b]  <span class="comment"># c中的a、b都是引用，引用指向两个列表</span></span><br><span class="line">d = copy.deepcopy(c)</span><br><span class="line">e = copy.copy(c)</span><br><span class="line"><span class="comment"># 虽然id(c)!=id(e)但是e中的[1, 2]、[3, 4]仍是a、b的引用，仅仅是把c的东西原封不动复制到e</span></span><br></pre></td></tr></table></figure>


</li>
</ul>
<h3 id="私有化"><a href="#私有化" class="headerlink" title="私有化"></a>私有化</h3><p>不同于面向对象的语言，python没有public、private等关键字。</p>
<ul>
<li>xx：共有变量</li>
<li>_x：单前置下划线，私有化属性或方法，<code>from somemodule import *</code>不会导入<code>_x</code>变量，类和对象子类可以访问</li>
<li>__xx：双前置下划线，私有化属性或方法，避免与子类中的属性冲突，无法在外部直接访问(名字重整所以访问不到)</li>
<li>__xx__：双前后下划线，用户名字空间的魔法对象属性，非私有</li>
<li>xx_：单后置下划线，用于避免与python关键词的冲突</li>
</ul>
<h3 id="import问题"><a href="#import问题" class="headerlink" title="import问题"></a>import问题</h3><p>程序执行时添加新的模块路径</p>
<p><code>sys.path</code>是个储存了模块路径的列表，因此可以使用列表操作改变搜索路径的优先级以及添加新路径</p>
<h4 id="重新导入模块问题"><a href="#重新导入模块问题" class="headerlink" title="重新导入模块问题"></a>重新导入模块问题</h4><p>import会防止模块重复导入，如果在程序执行期间修改了模块，即使使用import再次导入，修改的模块不会更新。需要使用</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> imp <span class="keyword">import</span> reload</span><br><span class="line"></span><br><span class="line">reload(somemodule)  <span class="comment"># 使用这种方式在不退出程序的情况下重新导入模块</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 但是对于from aa import bb这样的需求没有办法</span></span><br></pre></td></tr></table></figure>


<h4 id="多模块导入问题"><a href="#多模块导入问题" class="headerlink" title="多模块导入问题"></a>多模块导入问题</h4><p>在大型项目中一般会把很长的代码拆分成很多小的模块，这时模块间的数据传递就需要注意。一般把公共数据放在一个模块，这样方便访问、修改。</p>
<p><code>import aa</code>，<code>aa.bb = a</code>和<code>from aa import bb</code>，<code>bb=a</code>的区别</p>
<ul>
<li><code>import aa</code>使aa指向模块，则<code>aa.bb = a</code>是对模块aa的bb赋值，会改变aa中bb的值</li>
<li><code>from aa import bb</code>使得变量bb <strong>指向</strong> 模块aa中的同名变量bb，如果使用<code>bb = a</code>使得bb的指向改变，不会改变aa中的bb的值</li>
</ul>
<h3 id="面向对象"><a href="#面向对象" class="headerlink" title="面向对象"></a>面向对象</h3><h4 id="多继承以及MRO顺序"><a href="#多继承以及MRO顺序" class="headerlink" title="多继承以及MRO顺序"></a>多继承以及MRO顺序</h4><ul>
<li>调用父类方法的方式<ul>
<li><ol>
<li>通过父类的名字调用<ul>
<li>缺点是会根据类递归的调用，无形中造成资源浪费。如<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Class A:</span><br><span class="line">    __init__(self):</span><br><span class="line">        new_socket</span><br><span class="line">Class B(A):</span><br><span class="line">    __init__(self):</span><br><span class="line">        A.__init__(self)</span><br><span class="line">Class C(A):</span><br><span class="line">    __init__(self):</span><br><span class="line">        A.__init__(self)</span><br><span class="line">Class D(B, C):</span><br><span class="line">    __init__(self):</span><br><span class="line">        B.__init__(self)</span><br><span class="line">        C.__init__(self) </span><br><span class="line"><span class="comment"># B和C的init分别调用A的init导致多创建一个socket，造成浪费</span></span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ol>
</li>
<li><ol start="2">
<li>通过<code>super().xxx</code>调用<ul>
<li>不是更具类递归的调用，而是根据<code>ClassName.__mro__</code>中的顺序调用，保证了每个类只调用一次</li>
<li>如果多继承了多个同名方法，则根据<code>ClassName.__mro__</code>中的顺序决定super().xxx调用的是哪个(先后顺序)<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Class A:</span><br><span class="line">    __init__(self):</span><br><span class="line">        new_socket</span><br><span class="line">Class B(A):</span><br><span class="line">    __init__(self):</span><br><span class="line">        supter.__init__(self)</span><br><span class="line">Class C(A):</span><br><span class="line">    __init__(self):</span><br><span class="line">        super.__init__(self)</span><br><span class="line">Class D(B, C):</span><br><span class="line">    __init__(self):</span><br><span class="line">        super().__init__(self)</span><br><span class="line"><span class="comment"># 其中print(D.__mro__)=(D, B, C, A, object)</span></span><br><span class="line"><span class="comment"># 那么如果从D开始，如果父类都有调用super，则会根据mro中的顺序调用，即D、B、C、A</span></span><br></pre></td></tr></table></figure></li>
<li><code>super(ClassName, self)</code>，会从ClassName往后开始调用，如<code>super(B, self)</code>则顺序是B、C、A。默认从当前类开始</li>
</ul>
</li>
</ol>
</li>
</ul>
</li>
</ul>
<h4 id="可变参数"><a href="#可变参数" class="headerlink" title="可变参数"></a>可变参数</h4><ul>
<li><code>func(a, *args, **kwargs)</code><ul>
<li>一个<code>*</code>号以元祖的形式传递参数，变量名是args，<code>*</code>号只是告诉编译器</li>
<li>两个<code>*</code>号以字典的形式传递参数，变量名是kwargs<ul>
<li><strong>接收关键字参数</strong> ：如<code>func(1, 2, 3, 4, age=&#39;12&#39;, name=&#39;ring&#39;)</code><ul>
<li>args=(2, 3, 4)</li>
<li>kwargs={‘age’: ‘12’, ‘name’: ‘ring’}</li>
</ul>
</li>
<li>需要注意的是如果传的是一个字典，它并不是关键字参数，而是一个字典(一个整体)</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="静态方法和属性方法"><a href="#静态方法和属性方法" class="headerlink" title="静态方法和属性方法"></a>静态方法和属性方法</h4><ul>
<li>类对象和实例对象<ul>
<li>创建一个对象会从模板类中调用<code>__new__</code>分配内存空间，<code>__init__</code>初始化内存空间，<code>__class__</code>指向创建这个实例对象的类对象</li>
<li>对于公有的方法、属性存储在类对象中<ul>
<li>如方法<code>__inti__(self)</code>就不必每个实例都有一份，放在类对象中即可</li>
</ul>
</li>
<li>对于特有的方法、属性存储在类对象中<ul>
<li>如初始化name=ring，那么对于这个实例的name是ring，别的实例有所区别</li>
</ul>
</li>
</ul>
</li>
<li>类方法、实例方法、静态方法<ul>
<li>实例方法：一般的方法<ul>
<li>很难修改类属性，若<code>obj.class_state=&quot;xx&quot;</code>原来<code>class_state</code>是一个类属性。这个方法将导致实例里面新增一个名为<code>class_state</code>的属性<ul>
<li>要修改也是可以的<code>obj.__class__.class_state=&quot;xx&quot;</code>就可以修改<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">A</span>:</span></span><br><span class="line">        <span class="comment"># 实例方法</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">func</span><span class="params">(self)</span>:</span>  <span class="comment"># 默认传实例对象的引用self</span></span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line">    ```  </span><br><span class="line">* 类方式：用`@classmethod`装饰</span><br><span class="line">    ``` python</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">A</span>:</span></span><br><span class="line"><span class="meta">        @classmethod  # 类方法</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">func</span><span class="params">(cls)</span>:</span>  <span class="comment"># python解释器默认把类对象引用cls传入</span></span><br><span class="line">            <span class="keyword">pass</span></span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li>可以修改类属性</li>
</ul>
</li>
<li>静态方法：用<code>@staticmethod</code>装饰<ul>
<li>相当于在类外定义一个函数， <strong>不让python解释权默认传入类对象或实例对象</strong> 。写在类中是为例在不同类中区分开来</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="property属性"><a href="#property属性" class="headerlink" title="property属性"></a>property属性</h4><ul>
<li>用装饰器创建<ul>
<li>让代码更简洁，调用一个函数像取值、赋值一样</li>
<li>在普通方法前用<code>@property</code>修饰，如。把调用方法改成”调用属性”，但实际还是调用方法，只是可读性更高  <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span>:</span></span><br><span class="line">     </span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">func</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>  <span class="comment"># 必须返回一个值，且参数只有self</span></span><br><span class="line"></span><br><span class="line">a = A()</span><br><span class="line">a.func  <span class="comment"># 可以通过a.func调用，而不用a.func()</span></span><br></pre></td></tr></table></figure></li>
<li>新式类(继承object，python3默认继承)中有3中property装饰器  <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span>:</span></span><br><span class="line">     </span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">func</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>   <span class="comment"># 获取值</span></span><br><span class="line">     </span><br><span class="line"><span class="meta">    @property.setter</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">func</span><span class="params">(self, value)</span>:</span>  <span class="comment"># 要同名，且传入新值value</span></span><br><span class="line">        print(<span class="string">"some"</span>)  <span class="comment"># 设置值</span></span><br><span class="line">    <span class="comment"># 如可以调用xxx.func = 100</span></span><br><span class="line">  </span><br><span class="line"><span class="meta">    @property.deleter</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">func</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(<span class="string">"some"</span>)  <span class="comment"># 删除值</span></span><br><span class="line">    <span class="comment"># 如可以调用del xxx.func</span></span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li>通过类属性创建<ul>
<li><code>property(arg1, arg2, arg3, arg4)</code><ul>
<li>参数1是方法名，调用<code>对象.属性</code>时自动触发执行</li>
<li>(可选)参数2是方法名，调用<code>对象.属性=xx</code>时自动触发执行</li>
<li>(可选)参数3是方法名，调用<code>del 对象.属性</code>时自动触发执行</li>
<li>(可选)参数4是字符串，调用<code>对象.属性.__doc__</code>时此参数是该属性的描述信息<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span>:</span></span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">func</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span> </span><br><span class="line">    </span><br><span class="line">    FUNC = property(func)</span><br><span class="line"></span><br><span class="line">a = A()</span><br><span class="line">a.FUNC</span><br></pre></td></tr></table></figure>

</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="修改私有属性"><a href="#修改私有属性" class="headerlink" title="修改私有属性"></a>修改私有属性</h4><p>私有属性(在以<code>__</code>开头的变量)之所以无法访问是因为python悄悄改了变量名。如把<code>__func</code>改成了<code>_className__func</code>。所以使用这个改后的名就可以访问私有属性。这机制叫做名字重整。</p>
<h4 id="魔法属性-方法"><a href="#魔法属性-方法" class="headerlink" title="魔法属性/方法"></a>魔法属性/方法</h4><ul>
<li><code>__doc__</code>和<code>help()</code><ul>
<li>使用<code>var.__doc__</code>或<code>help(var)</code>可以查看写在开头的描述</li>
</ul>
</li>
<li><code>__module__</code>和<code>__class__</code><ul>
<li><code>__class__</code>表示当前操作的对象的类是什么</li>
<li><code>__module__</code>表示当前操作的对象是在哪个模块</li>
</ul>
</li>
<li><code>__init__</code><ul>
<li><strong>初始化</strong> 方法，创建类对象时自动触发执行</li>
</ul>
</li>
<li><code>__del__</code><ul>
<li>对象释放时，自动触发执行</li>
</ul>
</li>
<li><code>__call__</code><ul>
<li>对象后面加括号，触发执行<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">obj = classA()</span><br><span class="line">obj()   <span class="comment"># obj.__call__()</span></span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><code>__dict__</code><ul>
<li>类或对象的所有属性</li>
</ul>
</li>
<li><code>__str__</code><ul>
<li>如果一个类中定义了<code>__str__</code>方法，那么打印对象时，默认输出改方法的返回值</li>
</ul>
</li>
<li><code>__getitem__</code>、<code>__setitem__</code>、<code>__delitem</code><ul>
<li>如果类中实现了这3个方法，则可以当字典用<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__getitem__</span><span class="params">(self, key)</span>:</span></span><br><span class="line">        print(key)</span><br><span class="line">     </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__setitem__</span><span class="params">(self, key)</span>:</span></span><br><span class="line">        print(key)</span><br><span class="line">     </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__delitem__</span><span class="params">(self, key)</span>:</span></span><br><span class="line">        print(key)</span><br><span class="line"></span><br><span class="line">odj = A()</span><br><span class="line">res = obj[<span class="string">'k1'</span>]   <span class="comment"># __getitem__</span></span><br><span class="line">obj[<span class="string">'k2'</span>] = <span class="string">'abc'</span> <span class="comment"># __setitem__</span></span><br><span class="line"><span class="keyword">del</span> obj[<span class="string">'k3'</span>]     <span class="comment"># __delitem__</span></span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><code>__getslice__</code>、<code>__setslice__</code>、<code>__delslice__</code><ul>
<li>如果类中实现了这3个方法，则可以用于分片操作，如列表<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__setslice__</span><span class="params">(self, i, j)</span>:</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">     </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__setitem__</span><span class="params">(self, i, j)</span>:</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">     </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__delslice__</span><span class="params">(self, i, j)</span>:</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">odj = A()</span><br><span class="line">obj[<span class="number">-1</span>:<span class="number">1</span>]            <span class="comment"># __getslice__</span></span><br><span class="line">obj[<span class="number">0</span>:<span class="number">1</span>] = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>] <span class="comment"># __setslice__</span></span><br><span class="line"><span class="keyword">del</span> obj[<span class="number">0</span>:<span class="number">2</span>]         <span class="comment"># __delslice__</span></span><br></pre></td></tr></table></figure>


</li>
</ul>
</li>
</ul>
<h4 id="with与上下文管理器"><a href="#with与上下文管理器" class="headerlink" title="with与上下文管理器"></a>with与上下文管理器</h4><p>使用with打开文件能够保证最终文件都会关闭。如果采用传统的<code>f = open()</code>则需要try-catch辅助。with是一种更简洁的写法。</p>
<ul>
<li>上下文管理器<ul>
<li>任何实现了<code>__enter__()</code>和<code>__exit__()</code>方法的对象都可称之为上下文管理器。</li>
<li><code>__enter__()</code>返回资源对象</li>
<li><code>__exit__()</code>处理一些清理工作</li>
</ul>
</li>
</ul>
<p>当一个对象实现了上下文管理器，就可以使用with语句了</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> obj(args) <span class="keyword">as</span> f:  </span><br><span class="line">    <span class="comment"># obj()创建实例对象</span></span><br><span class="line">    <span class="comment"># with自动调用了obj(上下文管理器)的__enter__方法，enter的返回值赋给f</span></span><br><span class="line">    <span class="comment"># 如果产生了异常，将自动调用__exit__方法</span></span><br></pre></td></tr></table></figure>


<h3 id="闭包"><a href="#闭包" class="headerlink" title="闭包"></a>闭包</h3><p>多层函数嵌套、往往内部函数用到外部函数的变量，一个特殊的对象</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">func</span><span class="params">(a, b)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">solve</span><span class="params">(x)</span>:</span></span><br><span class="line">        print(a*x + b)</span><br><span class="line">    <span class="keyword">return</span> solve</span><br><span class="line"></span><br><span class="line">ans = func(<span class="number">1</span>, <span class="number">2</span>)</span><br><span class="line"><span class="comment"># 创造单独空间，包含参数a, b和solve函数。a, b相当于solve的全局变量</span></span><br><span class="line"><span class="comment"># 类似类，但比类开销小</span></span><br><span class="line">ans(<span class="number">0</span>)</span><br><span class="line">ans(<span class="number">1</span>)</span><br><span class="line">ans(<span class="number">2</span>)</span><br></pre></td></tr></table></figure>


<h4 id="修改数据"><a href="#修改数据" class="headerlink" title="修改数据"></a>修改数据</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">func</span><span class="params">()</span>:</span></span><br><span class="line">    x = <span class="number">100</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">solve</span><span class="params">()</span>:</span></span><br><span class="line">        <span class="keyword">nonlocal</span> x  <span class="comment"># 告诉解释器x不是solve中的，否则由于x=10的存在。会导致解释器认为x这个局部变量在声明前使用</span></span><br><span class="line">        print(x)</span><br><span class="line">        x = <span class="number">10</span>  </span><br><span class="line">        print(x)</span><br><span class="line">    <span class="keyword">return</span> solve</span><br></pre></td></tr></table></figure>


<h3 id="装饰器"><a href="#装饰器" class="headerlink" title="装饰器"></a>装饰器</h3><p>有时候我们需要进行一下重复的过程, 比如计算函数用时. 如果我们直接把逻辑写在函数内部, 逻辑混乱且可读性不高。这时我们就可以使用装饰器</p>
<h4 id="装饰器的基本实现过程"><a href="#装饰器的基本实现过程" class="headerlink" title="装饰器的基本实现过程"></a>装饰器的基本实现过程</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">set_func</span><span class="params">(func)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">call_func</span><span class="params">()</span>:</span></span><br><span class="line">        func()</span><br><span class="line">    <span class="keyword">return</span> call_func</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">test = set_func(test)</span><br><span class="line">test()</span><br><span class="line"></span><br><span class="line"><span class="comment">### 等价于</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@set_func  # 等价于test=set_func(test)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br></pre></td></tr></table></figure>


<h4 id="有参数的装饰器实现过程"><a href="#有参数的装饰器实现过程" class="headerlink" title="有参数的装饰器实现过程"></a>有参数的装饰器实现过程</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">set_func</span><span class="params">(func)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">call_func</span><span class="params">(a)</span>:</span>  <span class="comment"># 参数100会传到这</span></span><br><span class="line">        func(a)</span><br><span class="line">    <span class="keyword">return</span> call_func</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test</span><span class="params">(num)</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">test = set_func(test)</span><br><span class="line">test(<span class="number">100</span>)</span><br></pre></td></tr></table></figure>


<h4 id="不定参数的装饰器实现过程"><a href="#不定参数的装饰器实现过程" class="headerlink" title="不定参数的装饰器实现过程"></a>不定参数的装饰器实现过程</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">set_func</span><span class="params">(func)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">call_func</span><span class="params">(*args, **kwargs)</span>:</span>  <span class="comment"># 参数会传到这，这里的星号是告诉解释器</span></span><br><span class="line"></span><br><span class="line">        func(*args, **kwargs)  <span class="comment"># 这里的星号是拆包!!!，否则就是一个列表、一个字典</span></span><br><span class="line">    <span class="keyword">return</span> call_func</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test</span><span class="params">(age, num, *args, &amp;&amp;kwargs)</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">test = set_func(test)</span><br><span class="line">test(<span class="number">100</span>)</span><br></pre></td></tr></table></figure>


<h4 id="带有返回值的装饰器实现"><a href="#带有返回值的装饰器实现" class="headerlink" title="带有返回值的装饰器实现"></a>带有返回值的装饰器实现</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">set_func</span><span class="params">(func)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">call_func</span><span class="params">(*args, **kwargs)</span>:</span> </span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> func(*args, **kwargs)  <span class="comment"># 比包里调用，返回出去</span></span><br><span class="line">    <span class="keyword">return</span> call_func</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test</span><span class="params">(age, num, *args, &amp;&amp;kwargs)</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">test = set_func(test)</span><br><span class="line">test(<span class="number">100</span>)</span><br></pre></td></tr></table></figure>


<h4 id="给装饰器的参数"><a href="#给装饰器的参数" class="headerlink" title="给装饰器的参数"></a>给装饰器的参数</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">option</span><span class="params">(args)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">set_func</span><span class="params">(func)</span>:</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">call_func</span><span class="params">(*args, **kwargs)</span>:</span> </span><br><span class="line">            <span class="keyword">return</span> func(*args, **kwargs)</span><br><span class="line">        <span class="keyword">return</span> call_func</span><br><span class="line">    <span class="keyword">return</span> set_func</span><br><span class="line"></span><br><span class="line"><span class="meta">@option(args)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test</span><span class="params">(age, num, *args, &amp;&amp;kwargs)</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br></pre></td></tr></table></figure>

<p>装饰器需要一个函数指针，即@后跟函数名，由于option(args)不符合，所以先向下执行option(args)，返回的函数指针。@心满意足，用来装饰test函数</p>
<h4 id="多个装饰器对同一个函数进行装饰"><a href="#多个装饰器对同一个函数进行装饰" class="headerlink" title="多个装饰器对同一个函数进行装饰"></a>多个装饰器对同一个函数进行装饰</h4><p>先装下面的后装上面的。理解上面的实现过程。</p>
<p>执行效果是先执行上面的再执行下面的。所以装饰的顺序和想要的逻辑执行顺序相同即可。</p>
<h4 id="使用类当作装饰器"><a href="#使用类当作装饰器" class="headerlink" title="使用类当作装饰器"></a>使用类当作装饰器</h4><p>原理同闭包。只是变量名指向的不是函数，而是实例对象。</p>
<p>然后使用<code>变量名()</code>调用的是<code>实例对象.__call__()</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, func)</span>:</span></span><br><span class="line">        self.func = func</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.func()</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hello</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br></pre></td></tr></table></figure>


          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/02/26/universe/how_to_makefile/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/02/26/universe/how_to_makefile/" itemprop="url">How to makefile</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-02-26T00:00:00+08:00">
                2020-02-26
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="How-to-makefile"><a href="#How-to-makefile" class="headerlink" title="How to makefile"></a>How to makefile</h1><h2 id="Compile-process"><a href="#Compile-process" class="headerlink" title="Compile process"></a>Compile process</h2><p>How dose a project turn into an excutable file? There are four step:</p>
<ul>
<li>Preprocessing<ul>
<li>Unfold all include libs, macro, head. And produce <code>.i</code> file.</li>
<li>(gcc/g++ commands)<code>-E</code></li>
</ul>
</li>
<li>Compilation<ul>
<li>The <code>.i</code> file produce an <code>.s</code> file(assembly code).</li>
<li><code>-S</code></li>
</ul>
</li>
<li>Assemble<ul>
<li>The <code>.s</code> file produce an <code>.o</code> file(object file).It is a binary file.</li>
<li><code>-c</code></li>
</ul>
</li>
<li>Linking<ul>
<li>Linking the <code>.o</code> file produce an excutable file.</li>
</ul>
</li>
</ul>
<p>Whole example</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">gcc -E halo.c -o halo.i  </span><br><span class="line">gcc -S halo.i -o halo.s  </span><br><span class="line">gcc -c halo.s -o halo.o  </span><br><span class="line">gcc -o halo.o -o halo</span><br></pre></td></tr></table></figure>

<h2 id="Why-makefile"><a href="#Why-makefile" class="headerlink" title="Why makefile"></a>Why makefile</h2><p>As we see, compile a file include so much process.Though <code>gcc halo.c -o halo</code> can do the same thing as above, you need to make sure all the <code>.c</code> file are in the directory.<br>And what if a thousand file to compile?</p>
<h2 id="Lets-start"><a href="#Lets-start" class="headerlink" title="Lets start"></a>Lets start</h2><h3 id="Format"><a href="#Format" class="headerlink" title="Format"></a>Format</h3><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">target: dependencies</span></span><br><span class="line">    command</span><br><span class="line"></span><br><span class="line">^ before command IS A TAB, and make sure a new line at the end</span><br></pre></td></tr></table></figure>
<p>We should write “from rear to front”. Which means write final target command first and then write dependencies commandS</p>
<h3 id="Usage"><a href="#Usage" class="headerlink" title="Usage"></a>Usage</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make target...</span><br></pre></td></tr></table></figure>

<p>If didn’t specify target, run the first target as default. That is why should we wirte main object at first.</p>
<h1 id="CMake"><a href="#CMake" class="headerlink" title="CMake"></a>CMake</h1><p>Makefile may not work at different platform. Is quite annoying to rebuild a Makefile. So CMake is came.</p>
<p>CMake can auto generate Makefile, it is more cross-platform.</p>
<p>Usually, cmake command write in a <code>CMakeLists.txt</code> file.</p>
<h2 id="Some-basic"><a href="#Some-basic" class="headerlink" title="Some basic"></a>Some basic</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">CMAKE_MINIMUM_REQUIRED(VERSION define_a_minimum_version_here)</span><br><span class="line"></span><br><span class="line">PROJECT(define_project_name)</span><br><span class="line"></span><br><span class="line">AUX_SOURCE_DIRECTORY(&#x2F;your&#x2F;dir&#x2F;source pkg_name)  # to packaging files in dir_source. So you do not need every single source file below.</span><br><span class="line"></span><br><span class="line">ADD_EXECUTABLE(executalbe_name source_files...)</span><br><span class="line"># or</span><br><span class="line">ADD_EXECUTABLE(executalbe_name $&#123;pkg_name&#125;)</span><br></pre></td></tr></table></figure>

<h2 id="Multi-Dir-CMake"><a href="#Multi-Dir-CMake" class="headerlink" title="Multi Dir CMake"></a>Multi Dir CMake</h2><p>Every sub dir need a CMake file. So your main CMake file can use it.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">AUX_SOURCE_DIRECTORY(&#x2F;your&#x2F;dir&#x2F;source pkg_name)</span><br><span class="line"></span><br><span class="line"># static library</span><br><span class="line">ADD_LIBRARY(lib_name STATIC $&#123;pkg_name&#125;)  </span><br><span class="line"></span><br><span class="line"># dynamic library</span><br><span class="line">ADD_LIBRARY(lib_name SHARED $&#123;pkg_name&#125;)</span><br></pre></td></tr></table></figure>

<p>Use sub dir</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">CMAKE_MINIMUM_REQUIRED(VERSION minimum_version)</span><br><span class="line"></span><br><span class="line">PROJECT(project_name)</span><br><span class="line"></span><br><span class="line">ADD_SUBDIRACTORY(.&#x2F;subdir)  # add subdir</span><br><span class="line"></span><br><span class="line">AUX_SOURCE_DIRECTORY(&#x2F;your&#x2F;dir&#x2F;source pkg_name)</span><br><span class="line"></span><br><span class="line">ADD_EXECUTABLE(executalbe_name $&#123;pkg_name&#125;)</span><br><span class="line"></span><br><span class="line">TARGET_LINKLIBRARYS(executalbe_name SubLib)  # link sub lib</span><br></pre></td></tr></table></figure>


<h2 id="Standard-Project"><a href="#Standard-Project" class="headerlink" title="Standard Project"></a>Standard Project</h2><p>📁/Project<br>—📁/build<br>—📁/src<br>—📁/lib<br>—📝/CMakeLists.txt</p>
<ul>
<li><p><code>./src/CMakeLists.txt</code></p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">INCLUDE_DIRECTORY(.&#x2F;path&#x2F;to&#x2F;lib)  #INCLUDE_DIRECTORY(.&#x2F;lib)</span><br><span class="line"></span><br><span class="line">SET(EXECUTABLE_OUTPUT_PATH $(PROJECT_BINARARY_DIR)&#x2F;bin)</span><br><span class="line"># set executable output to EXECUTABLE_OUTPUT_PATH&#x2F;bin &#x3D;..&#x2F;build&#x2F;bin</span><br><span class="line"></span><br><span class="line">AUX_SOURCE_DIRECTORY(&#x2F;your&#x2F;dir&#x2F;source pkg_name)</span><br><span class="line"></span><br><span class="line">ADD_EXECUTABLE(executalbe_name $&#123;pkg_name&#125;)</span><br><span class="line"></span><br><span class="line">TARGET_LINKLIBRARYS(executalbe_name SubLib)  # link sub lib</span><br></pre></td></tr></table></figure></li>
<li><p><code>./lib/CMakeLists.txt</code></p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">AUX_SOURCE_DIRECTORY(&#x2F;your&#x2F;dir&#x2F;source pkg_name)</span><br><span class="line"></span><br><span class="line">SET(LIBRARAY_OUTPUT_PATH $(PROJECT_BINARARY_DIR)&#x2F;lib)</span><br><span class="line"># set library output to PROJECT_BINARARY_DIR&#x2F;lib&#x3D;..&#x2F;build&#x2F;lib</span><br><span class="line"></span><br><span class="line"># static library</span><br><span class="line">ADD_LIBRARY(lib_name STATIC $&#123;pkg_name&#125;)  </span><br><span class="line"></span><br><span class="line"># dynamic library</span><br><span class="line">ADD_LIBRARY(lib_name SHARED $&#123;pkg_name&#125;)</span><br></pre></td></tr></table></figure></li>
<li><p><code>./CMakeLists.txt</code></p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">CMAKE_MINIMUM_REQUIRED(VERSION minimum_version)</span><br><span class="line"></span><br><span class="line">PROJECT(project_name)</span><br><span class="line"></span><br><span class="line">ADD_SUBDIRACTORY(.&#x2F;subdir)  # add subdir</span><br><span class="line"></span><br><span class="line">ADD_SUBDIRACTORY(.&#x2F;src)</span><br></pre></td></tr></table></figure>
</li>
<li><p>ccmake(config cmake)</p>
</li>
<li><p>some other option</p>
</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/02/26/universe/vim_in_action/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/02/26/universe/vim_in_action/" itemprop="url">vim实用技巧</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-02-26T00:00:00+08:00">
                2020-02-26
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Vim实用技巧"><a href="#Vim实用技巧" class="headerlink" title="Vim实用技巧"></a>Vim实用技巧</h1><h2 id="杂项"><a href="#杂项" class="headerlink" title="杂项"></a>杂项</h2><table>
<thead>
<tr>
<th>操作</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>o</td>
<td>切换高亮中光标所在的端点</td>
</tr>
<tr>
<td>.</td>
<td>重复执行上一步操作</td>
</tr>
<tr>
<td>%</td>
<td>它代表当前文件中的所有行</td>
</tr>
<tr>
<td>%</td>
<td>可以在一组开, 闭括号间跳转</td>
</tr>
<tr>
<td>m{mark}</td>
<td>当前位置标记为{mark}以便以后跳转</td>
</tr>
<tr>
<td>`{mark}</td>
<td>跳到{mark}标记处</td>
</tr>
<tr>
<td>qa</td>
<td>录制宏到寄存器a</td>
</tr>
<tr>
<td>qA</td>
<td>往寄存器a中追加操作</td>
</tr>
<tr>
<td>i/d{</td>
<td>i for inside, a for around, 就可以用di/da等操作</td>
</tr>
<tr>
<td>=i{</td>
<td>=格式化?(缩进), inside {}</td>
</tr>
<tr>
<td>:earlier/later 1m</td>
<td>回到1min前/后</td>
</tr>
<tr>
<td>c-z</td>
<td>挂起vim,命令行下:$ fg可以恢复,jobs查看挂起的进程</td>
</tr>
<tr>
<td>c-a/c-x</td>
<td>数字加/减1</td>
</tr>
</tbody></table>
<h2 id="查找"><a href="#查找" class="headerlink" title="查找"></a>查找</h2><table>
<thead>
<tr>
<th>操作</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>*</td>
<td>向下查找光标停靠的词语</td>
</tr>
<tr>
<td>#</td>
<td>向上查找</td>
</tr>
<tr>
<td>;</td>
<td>重复上一次查找</td>
</tr>
<tr>
<td>,</td>
<td>反转方向重复上一次查找</td>
</tr>
<tr>
<td>\ze和\ze</td>
<td>匹配界定符, 匹配边界</td>
</tr>
</tbody></table>
<h3 id="按正则表达式查找"><a href="#按正则表达式查找" class="headerlink" title="按正则表达式查找"></a>按正则表达式查找</h3><table>
<thead>
<tr>
<th>操作</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>\v</td>
<td>使用正则的特殊符号规则</td>
</tr>
<tr>
<td>\V</td>
<td>原意查找, 即.啊什么的不用反斜转意</td>
</tr>
<tr>
<td>\w</td>
<td>用来匹配单词类字符, 包括字母,数字及符号</td>
</tr>
<tr>
<td>\W</td>
<td>匹配单词类以外的所有字符</td>
</tr>
<tr>
<td>\{num}</td>
<td>引用被没对()捕获的子匹配 \0会引用整个匹配</td>
</tr>
<tr>
<td>&lt;和&gt;</td>
<td>\v模式中&lt;和&gt;用来匹配边界</td>
</tr>
</tbody></table>
<h2 id="操作符-动作-操作"><a href="#操作符-动作-操作" class="headerlink" title="操作符 + 动作 = 操作"></a>操作符 + 动作 = 操作</h2><h3 id="操作符"><a href="#操作符" class="headerlink" title="操作符"></a>操作符</h3><table>
<thead>
<tr>
<th>操作</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>c</td>
<td>修改</td>
</tr>
<tr>
<td>d</td>
<td>删除</td>
</tr>
<tr>
<td>y</td>
<td>复制到寄存器</td>
</tr>
<tr>
<td>g~</td>
<td>反转大小写</td>
</tr>
<tr>
<td>gu</td>
<td>反转为小写</td>
</tr>
<tr>
<td>gU</td>
<td>反转为大写</td>
</tr>
<tr>
<td>&gt;</td>
<td>增加缩进</td>
</tr>
<tr>
<td>&lt;</td>
<td>减小缩进</td>
</tr>
<tr>
<td>=</td>
<td>自动缩进</td>
</tr>
<tr>
<td>!</td>
<td>使用外部程序</td>
</tr>
</tbody></table>
<h3 id="动作"><a href="#动作" class="headerlink" title="动作"></a>动作</h3><table>
<thead>
<tr>
<th>操作</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>w</td>
<td>向后一个单词</td>
</tr>
<tr>
<td>W</td>
<td>当前字串</td>
</tr>
<tr>
<td>aw</td>
<td>a word, 光标停靠的整个单词及一个空格</td>
</tr>
<tr>
<td>ab</td>
<td>一对圆括号</td>
</tr>
<tr>
<td>aB</td>
<td>一对花括号</td>
</tr>
<tr>
<td>t</td>
<td>to 到</td>
</tr>
<tr>
<td>i”</td>
<td>inside 在””中</td>
</tr>
<tr>
<td>it</td>
<td>inside tag <h1></h1></td>
</tr>
<tr>
<td>p</td>
<td>段落</td>
</tr>
<tr>
<td>s</td>
<td>句子</td>
</tr>
<tr>
<td>@a</td>
<td>宏a</td>
</tr>
</tbody></table>
<h3 id="例子"><a href="#例子" class="headerlink" title="例子"></a>例子</h3><table>
<thead>
<tr>
<th>操作</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>caw</td>
<td>修改当期单词</td>
</tr>
<tr>
<td>dta</td>
<td>删除当前位置到字母啊</td>
</tr>
<tr>
<td>以此类推</td>
<td></td>
</tr>
</tbody></table>
<h2 id="Ctrl-x补全"><a href="#Ctrl-x补全" class="headerlink" title="Ctrl+x补全"></a>Ctrl+x补全</h2><table>
<thead>
<tr>
<th>操作</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>c-x,c-r</td>
<td>insert from a register</td>
</tr>
<tr>
<td>c-x,c-a</td>
<td>last inserted text</td>
</tr>
<tr>
<td>c-x,c-]</td>
<td>tag completion</td>
</tr>
<tr>
<td>c-x,c-f</td>
<td>filename completion</td>
</tr>
<tr>
<td>c-x,c-p/c-n</td>
<td>context-aware word completion</td>
</tr>
<tr>
<td>c-x,l</td>
<td>context-aware line completion</td>
</tr>
</tbody></table>
<h2 id="寄存器"><a href="#寄存器" class="headerlink" title="寄存器"></a>寄存器</h2><table>
<thead>
<tr>
<th>操作</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>“{register}</td>
<td>制定寄存器{register}</td>
</tr>
<tr>
<td>“”</td>
<td>无名寄存器, 没指定寄存器情况下缺省使用</td>
</tr>
<tr>
<td>“0</td>
<td>复制专用寄存器</td>
</tr>
<tr>
<td>“_</td>
<td>黑洞寄存器, 有去无回</td>
</tr>
<tr>
<td>“+</td>
<td>X11剪贴板</td>
</tr>
<tr>
<td>&lt;C-r&gt;{register}</td>
<td>在在插入模式下插入寄存器内容</td>
</tr>
<tr>
<td>:reg a</td>
<td>查看寄存器a</td>
</tr>
<tr>
<td>等等</td>
<td></td>
</tr>
</tbody></table>
<h2 id="Shell命令"><a href="#Shell命令" class="headerlink" title="Shell命令"></a>Shell命令</h2><table>
<thead>
<tr>
<th>操作</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>%</td>
<td>命令行中的%会展开成当前文件的完整路径</td>
</tr>
<tr>
<td>:shell</td>
<td>启动一个shell(输入exit返回vim)</td>
</tr>
<tr>
<td>:!{cmd}</td>
<td>在shell中执行{cmd}</td>
</tr>
<tr>
<td>:read !{cmd}</td>
<td>把{cmd}的标准输出插入到光标下方</td>
</tr>
<tr>
<td>:[range]write !{cmd}</td>
<td>以[range]作为{cmd}的标准输入</td>
</tr>
</tbody></table>
<h2 id="分屏操作"><a href="#分屏操作" class="headerlink" title="分屏操作"></a>分屏操作</h2><table>
<thead>
<tr>
<th>操作</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>&lt;C-w&gt;=</td>
<td>使得所有窗口等宽, 登高</td>
</tr>
<tr>
<td>&lt;C-w&gt;_</td>
<td>最大化活动窗口的高度</td>
</tr>
<tr>
<td>&lt;C-w&gt;|</td>
<td>最大化活动窗口的宽度</td>
</tr>
<tr>
<td>&lt;C-w&gt;方向</td>
<td>移动光标所在的窗口</td>
</tr>
</tbody></table>
<h2 id="地址"><a href="#地址" class="headerlink" title="地址"></a>地址</h2><table>
<thead>
<tr>
<th>操作</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>0</td>
<td>虚拟行, 位于第一行上方</td>
</tr>
<tr>
<td>1</td>
<td>文件第一行</td>
</tr>
<tr>
<td>$</td>
<td>最后一行</td>
</tr>
<tr>
<td>.</td>
<td>光标所在行</td>
</tr>
<tr>
<td>‘m</td>
<td>包含位置标记m的行</td>
</tr>
<tr>
<td>‘&lt;</td>
<td>高亮选取的起始行</td>
</tr>
<tr>
<td>‘&gt;</td>
<td>高亮选取的结束行</td>
</tr>
<tr>
<td>%</td>
<td>整个文件</td>
</tr>
</tbody></table>
<h2 id="宏"><a href="#宏" class="headerlink" title="宏"></a>宏</h2><p>录制宏其实是把操作过程放入了一个寄存器中，如<code>qq</code>就是用寄存器q来录制宏。用<code>:reg q</code>可以查看内容。</p>
<ul>
<li><code>qq</code>：用寄存器q录制宏</li>
<li><code>qQ</code>:往寄存器q中追加操作</li>
<li><code>:put q</code>：把寄存器q的内容粘贴到文档，以便修改</li>
<li><code>:d q</code>：复制回寄存器</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/02/25/universe/GDB_Usage/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/02/25/universe/GDB_Usage/" itemprop="url">GDB usage</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-02-25T00:00:00+08:00">
                2020-02-25
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Basic-Usage"><a href="#Basic-Usage" class="headerlink" title="Basic Usage"></a>Basic Usage</h1><ul>
<li>Make sure compile file with <code>-g</code> option, which mean turn on debugging with gdb<ul>
<li>like this: <code>gcc -g main.cpp -o main</code></li>
</ul>
</li>
</ul>
<h2 id="Debugging-with-GDB"><a href="#Debugging-with-GDB" class="headerlink" title="Debugging with GDB"></a>Debugging with GDB</h2><ul>
<li>open file<ul>
<li>here are two way</li>
<li><code>gdb filename</code><ul>
<li><code>gdb path/to/main</code></li>
</ul>
</li>
<li><code>gdb</code> -&gt; <code>file path/to/main</code></li>
</ul>
</li>
<li>show list<ul>
<li>use <code>l</code> command to show source code with line number</li>
</ul>
</li>
<li>add breakpoint<ul>
<li>use <code>b linenum</code> to add breakpoint, such as <code>b 1</code> add breakpoint at line 1</li>
<li>or use <code>b functionname</code> to add breakpoint, such as <code>b main</code> add breakpoint at main function</li>
</ul>
</li>
<li>show breakpoint information<ul>
<li><code>i b</code> i for information, b for breakpoint</li>
</ul>
</li>
<li>delete breakpoint<ul>
<li><code>d pointid</code> pointid from <code>i b</code></li>
<li><code>i b</code> information will be like a order list. If delete a pointid in the previous, the next point will just add in the end of the idlist.</li>
</ul>
</li>
<li>run debug<ul>
<li><code>r</code></li>
<li>use <code>p variable</code> will show the variable information</li>
</ul>
</li>
<li>gdb controler<ul>
<li><code>n</code> for next line, one step debugging</li>
<li><code>s</code> for step into(one step)</li>
<li><code>set args [parameter]</code> for command line args</li>
</ul>
</li>
<li>finish function and continue<ul>
<li><code>finish</code> for finish function</li>
<li><code>c</code> for continue until program exit or breakpoint</li>
</ul>
</li>
<li>quit gdb<ul>
<li><code>q</code></li>
</ul>
</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/02/25/universe/linux/linux%E5%93%B2%E5%AD%A6%E8%AE%B0%E5%BD%95/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/02/25/universe/linux/linux%E5%93%B2%E5%AD%A6%E8%AE%B0%E5%BD%95/" itemprop="url">Linux哲学记录</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-02-25T00:00:00+08:00">
                2020-02-25
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h4 id="开发效率问题"><a href="#开发效率问题" class="headerlink" title="开发效率问题"></a>开发效率问题</h4><p><strong>闭源</strong> </p>
<p>在一个项目开发中<br>假设一个人开发效率是100%, 因为他能全身心投入项目中. 两个人每个人的开发效率是80%, 其中20%是因为另一个人损耗的沟通成本, 那么两个人的效率就像一个人的160%.<br>但是如果人数增加, 每个人的沟通成本也会增加, 最后发现效率降低. 所以一个多人开发的大型项目理论上是不可能成功的.</p>
<p>那么框架, 框架的扩展性就显得尤其重要.</p>
<p><strong>开源</strong></p>
<p>一个开源项目往往有成百上千的人参与, 那根据上面的理论, 一个开源项目就不会成功.<br>但是当人数多到一定程度的时候, 一个潜在的错误一旦出现就会立刻得到解决, 反而大大提高了效率.<br>但是当人数多到一定程度的时候, 已经不在上面理论的范畴之内了, 就像物理世界的<strong>宏观和微观问题</strong>.<br>在多人开发的开源项目中的理论就遵循<em>linus</em> 提出的<strong>linus理论</strong>. 开源项目的成功就足以证明其正确性.</p>
<h4 id="开源程序的责任"><a href="#开源程序的责任" class="headerlink" title="开源程序的责任"></a>开源程序的责任</h4><p>一个开源程序往往有一个开源协议, 这些协议往往把责任只想广大社区的开发者, 也就是我们自己.<br>所以我们获取的开源软件我们自己, 我们广大开发者就要对其负责.</p>
<p>举个例子:比如你找学霸抄作业, 但是抄来的答案全是错是, 你该怪学霸吗?<br>于是你在抄之前, 问了一下别人是不是也抄了学霸的作业, 别人告诉你说没问题, 或者你检查了一遍发现没问题. 那社区就保证了它的安全性.</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/02/23/universe/linux/linux_tips/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/02/23/universe/linux/linux_tips/" itemprop="url">linux command line</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-02-23T00:00:00+08:00">
                2020-02-23
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Command-line"><a href="#Command-line" class="headerlink" title="Command line"></a>Command line</h1><h2 id="Some-Ussful-tips"><a href="#Some-Ussful-tips" class="headerlink" title="Some Ussful tips"></a>Some Ussful tips</h2><ul>
<li><code>#</code> can delete a sub-string <strong>from the very beginning</strong> , like <code>var=apple; echo ${var#app}</code>, which will print <code>le</code>. <ul>
<li><code>#</code>, delete a few things as posible</li>
<li><code>##</code>, (greedy)delete a more things as posible</li>
<li><code>%</code>, use like <code>#</code>, but it delete from the end<ul>
<li><code>echo ${var%el}</code>, print app</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="shebang"><a href="#shebang" class="headerlink" title="shebang"></a>shebang</h2><p>a shebang is the interpreter of this script. like this</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br></pre></td></tr></table></figure>

<h2 id="Redirection"><a href="#Redirection" class="headerlink" title="Redirection"></a>Redirection</h2><table>
<thead>
<tr>
<th>command</th>
<th>function</th>
</tr>
</thead>
<tbody><tr>
<td>a &gt; b</td>
<td>a’s std output override into b</td>
</tr>
<tr>
<td>a &gt;&gt; b</td>
<td>a’s std output appand into b</td>
</tr>
<tr>
<td>a &lt; b</td>
<td>b as a’s input</td>
</tr>
<tr>
<td>a &lt;&lt; b</td>
<td>here document</td>
</tr>
<tr>
<td>a &lt;&lt;&lt; b</td>
<td>here</td>
</tr>
</tbody></table>
<h3 id="Here-document"><a href="#Here-document" class="headerlink" title="Here document"></a>Here document</h3><p>A block as input</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> &lt;&lt; token</span><br><span class="line">    text</span><br><span class="line">token</span><br><span class="line"></span><br><span class="line">example:</span><br><span class="line"><span class="built_in">echo</span> &lt;&lt; __EOF__</span><br><span class="line">halo</span><br><span class="line">__EOF__</span><br><span class="line"></span><br><span class="line">$ halo</span><br></pre></td></tr></table></figure>

<h3 id="Here"><a href="#Here" class="headerlink" title="Here"></a>Here</h3><p>a bit like <em>here document</em>, a line as input.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">read</span> ans1 ans2 ans3 &lt;&lt;&lt; <span class="string">"a1 a2 a3"</span></span><br><span class="line"></span><br><span class="line">a1 a2 a3 as input to <span class="built_in">read</span> process</span><br></pre></td></tr></table></figure>

<h2 id="Useful-commands"><a href="#Useful-commands" class="headerlink" title="Useful commands"></a>Useful commands</h2><h3 id="Grep"><a href="#Grep" class="headerlink" title="Grep"></a>Grep</h3><p><code>grep [option] file1 file2...</code></p>
<p>The most commonly used<br>| options  | description                    |<br>|———-|——————————–|<br>| -i       | –ignore-case                  |<br>| -v       | –revert-mathch                |<br>| -c       | –count                        |<br>| -l       | –file-with-match              |<br>| -L       | –file-without-math            |<br>| -n       | –line-number                  |<br>| -h       | no filename in multi file mode |<br>| -a/-text | do not ignore binary data      |<br>| -e       | –regexp                       |<br>| -f       | specify regexp file            |</p>
<h3 id="Sed"><a href="#Sed" class="headerlink" title="Sed"></a>Sed</h3><p>sed can deal with text file with script-command or script-file.</p>
<p><code>sed [options][target-file]</code></p>
<table>
<thead>
<tr>
<th>options</th>
<th>description</th>
</tr>
</thead>
<tbody><tr>
<td>-e</td>
<td></td>
</tr>
<tr>
<td>&lt;++&gt;</td>
<td>&lt;++&gt;</td>
</tr>
<tr>
<td>&lt;++&gt;</td>
<td>&lt;++&gt;</td>
</tr>
<tr>
<td>&lt;++&gt;</td>
<td>&lt;++&gt;</td>
</tr>
<tr>
<td>&lt;++&gt;</td>
<td>&lt;++&gt;</td>
</tr>
<tr>
<td>&lt;++&gt;</td>
<td>&lt;++&gt;</td>
</tr>
<tr>
<td>&lt;++&gt;</td>
<td>&lt;++&gt;</td>
</tr>
</tbody></table>
<p>script action</p>
<table>
<thead>
<tr>
<th>action</th>
<th>description</th>
</tr>
</thead>
<tbody><tr>
<td>a\</td>
<td>add a new line or lines next to current line</td>
</tr>
<tr>
<td>c\</td>
<td>replace current line with some text</td>
</tr>
<tr>
<td>d</td>
<td>delete line</td>
</tr>
<tr>
<td>i\</td>
<td>insert text befor curent line</td>
</tr>
<tr>
<td>h</td>
<td>&lt;++&gt;</td>
</tr>
<tr>
<td>H</td>
<td>&lt;++&gt;</td>
</tr>
<tr>
<td>g</td>
<td>&lt;++&gt;</td>
</tr>
<tr>
<td>G</td>
<td>&lt;++&gt;</td>
</tr>
<tr>
<td>I</td>
<td>&lt;++&gt;</td>
</tr>
<tr>
<td>p</td>
<td>print line</td>
</tr>
<tr>
<td>n</td>
<td>&lt;++&gt;</td>
</tr>
<tr>
<td>q</td>
<td>quit sed</td>
</tr>
<tr>
<td>r</td>
<td>&lt;++&gt;</td>
</tr>
<tr>
<td>!</td>
<td>&lt;++&gt;</td>
</tr>
<tr>
<td>s</td>
<td>replace string with other string</td>
</tr>
<tr>
<td>&lt;++&gt;</td>
<td>&lt;++&gt;</td>
</tr>
<tr>
<td>&lt;++&gt;</td>
<td>&lt;++&gt;</td>
</tr>
<tr>
<td>&lt;++&gt;</td>
<td>&lt;++&gt;</td>
</tr>
<tr>
<td>&lt;++&gt;</td>
<td>&lt;++&gt;</td>
</tr>
<tr>
<td>&lt;++&gt;</td>
<td>&lt;++&gt;</td>
</tr>
</tbody></table>
<p>replace identifier</p>
<table>
<thead>
<tr>
<th>options</th>
<th>description</th>
</tr>
</thead>
<tbody><tr>
<td>g</td>
<td>global replace in this line</td>
</tr>
<tr>
<td>p</td>
<td>print line</td>
</tr>
<tr>
<td>w</td>
<td>write line into file</td>
</tr>
<tr>
<td>x</td>
<td>&lt;++&gt;</td>
</tr>
<tr>
<td>y</td>
<td>&lt;++&gt;</td>
</tr>
<tr>
<td>&lt;++&gt;</td>
<td>&lt;++&gt;</td>
</tr>
</tbody></table>
<h3 id="Cut"><a href="#Cut" class="headerlink" title="Cut"></a>Cut</h3><table>
<thead>
<tr>
<th>options</th>
<th>description</th>
</tr>
</thead>
<tbody><tr>
<td>&lt;++&gt;</td>
<td>&lt;++&gt;</td>
</tr>
<tr>
<td>&lt;++&gt;</td>
<td>&lt;++&gt;</td>
</tr>
<tr>
<td>&lt;++&gt;</td>
<td>&lt;++&gt;</td>
</tr>
<tr>
<td>&lt;++&gt;</td>
<td>&lt;++&gt;</td>
</tr>
<tr>
<td>&lt;++&gt;</td>
<td>&lt;++&gt;</td>
</tr>
<tr>
<td>&lt;++&gt;</td>
<td>&lt;++&gt;</td>
</tr>
<tr>
<td>&lt;++&gt;</td>
<td>&lt;++&gt;</td>
</tr>
</tbody></table>
<h2 id="Regular-Expressions"><a href="#Regular-Expressions" class="headerlink" title="Regular Expressions"></a>Regular Expressions</h2><h3 id="Literals"><a href="#Literals" class="headerlink" title="Literals"></a>Literals</h3><table>
<thead>
<tr>
<th>pattern</th>
<th>description</th>
</tr>
</thead>
<tbody><tr>
<td>.</td>
<td>match any char</td>
</tr>
<tr>
<td>char</td>
<td>literaly a char</td>
</tr>
</tbody></table>
<h3 id="Metacharacters"><a href="#Metacharacters" class="headerlink" title="Metacharacters"></a>Metacharacters</h3><h4 id="Anchors"><a href="#Anchors" class="headerlink" title="Anchors"></a>Anchors</h4><table>
<thead>
<tr>
<th>pattern</th>
<th>description</th>
</tr>
</thead>
<tbody><tr>
<td>^</td>
<td>found at the begin of line</td>
</tr>
<tr>
<td>$</td>
<td>found at the end of line</td>
</tr>
</tbody></table>
<h4 id="Quantifiers"><a href="#Quantifiers" class="headerlink" title="Quantifiers"></a>Quantifiers</h4><table>
<thead>
<tr>
<th>pattern</th>
<th>description</th>
</tr>
</thead>
<tbody><tr>
<td>?</td>
<td>match <strong>an element</strong> zero or one time</td>
</tr>
<tr>
<td>*</td>
<td>match <strong>an element</strong> zero or more times</td>
</tr>
<tr>
<td>+</td>
<td>match <strong>an element</strong> one or more times</td>
</tr>
<tr>
<td>{}</td>
<td>match <strong>an element</strong> a specific number of times</td>
</tr>
<tr>
<td>{n,}</td>
<td>match <strong>an element</strong> if it occurs n or more times</td>
</tr>
<tr>
<td>{,n}</td>
<td>match <strong>an element</strong> if it occurs no more than n times</td>
</tr>
</tbody></table>
<p>A quantifiers is after <strong>an element</strong>, such as <code>.*</code> means match any char with any lengh equivalent any string.</p>
<p>An element can like this <code>[A_Z]</code>and this<code>[:digit:]</code>. We can see the pattern before a quantifiers as a whole.</p>
<h4 id="Bracket-Expressions-and-Character-Classes"><a href="#Bracket-Expressions-and-Character-Classes" class="headerlink" title="Bracket Expressions and Character Classes"></a>Bracket Expressions and Character Classes</h4><ul>
<li><p>Bracket Expressions</p>
<ul>
<li>specify a set of characters to be match<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ grep -h <span class="string">'[bg]zip'</span> test.txt</span><br><span class="line">bzip2</span><br><span class="line">bzip123</span><br><span class="line">gzip</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>Negation</p>
<ul>
<li>If the first char in a bracket expression is a caret(^), the <strong>remaining char</strong> are taken to be a set of chars that must not be present at the given char position.<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ grep -h <span class="string">'[^bg]zip'</span> test.txt</span><br><span class="line">bunzip</span><br><span class="line">gunzip</span><br><span class="line">funzip</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>Character Classes</p>
<ul>
<li>A set of characters range<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ grep -h <span class="string">'[^ABCDEF]'</span> test.txt</span><br><span class="line">or you can</span><br><span class="line">$ grep -h <span class="string">'[^A-F]'</span> test.txt</span><br><span class="line"></span><br><span class="line">Here are more expressions</span><br><span class="line">$ grep -h <span class="string">'[A-Fa-z0-9]'</span> test.txt</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>POSIX Character Class</p>
</li>
</ul>
<table>
<thead>
<tr>
<th>char</th>
<th>description</th>
</tr>
</thead>
<tbody><tr>
<td>[:alnum:]</td>
<td>alphanumeric characters.equivalent to[A-Za-z0-9]</td>
</tr>
<tr>
<td>[:word:]</td>
<td>same as alnum, with the addition of the underscore char(_)</td>
</tr>
<tr>
<td>[:alpha:]</td>
<td>[A-Za-z]</td>
</tr>
<tr>
<td>[:blank:]</td>
<td>space and tab char</td>
</tr>
<tr>
<td>[:digit:]</td>
<td>number 0 through 9</td>
</tr>
<tr>
<td>[:lower:]</td>
<td>the lowercase letters</td>
</tr>
<tr>
<td>[:upper:]</td>
<td>the uppercase letters</td>
</tr>
<tr>
<td>[:space:]</td>
<td>[\t\r\n\v\f]</td>
</tr>
<tr>
<td>[:xdigit:]</td>
<td>chars used to express hexadecimal numbers.[0-9a-fA-F]</td>
</tr>
</tbody></table>
<h2 id="Flow-control"><a href="#Flow-control" class="headerlink" title="Flow control"></a>Flow control</h2><h3 id="if-statements"><a href="#if-statements" class="headerlink" title="if statements"></a>if statements</h3><h4 id="File-Expressions"><a href="#File-Expressions" class="headerlink" title="File Expressions"></a>File Expressions</h4><table>
<thead>
<tr>
<th>command</th>
<th>description</th>
</tr>
</thead>
<tbody><tr>
<td>f1 -ef f2</td>
<td>f1 and f2 have the same indoe number</td>
</tr>
<tr>
<td>f1 -nt f2</td>
<td>f1 newer than f2</td>
</tr>
<tr>
<td>f1 -ot f2</td>
<td>f1 older than f2</td>
</tr>
<tr>
<td>-d f1</td>
<td>f1 exists an is a directory</td>
</tr>
<tr>
<td>-e f1</td>
<td>f1 exists</td>
</tr>
<tr>
<td>-f f1</td>
<td>f1 is a regular file</td>
</tr>
</tbody></table>
<h4 id="String-Expressions"><a href="#String-Expressions" class="headerlink" title="String Expressions"></a>String Expressions</h4><table>
<thead>
<tr>
<th>command</th>
<th>description</th>
</tr>
</thead>
<tbody><tr>
<td>string</td>
<td>string is not null</td>
</tr>
<tr>
<td>-n string</td>
<td>the lenth of string is greater than zero</td>
</tr>
<tr>
<td>-z string</td>
<td>the lenth of string is zero</td>
</tr>
<tr>
<td>s1 = s2 or s1 == s2</td>
<td>equal</td>
</tr>
<tr>
<td>s1 !=s2</td>
<td>not equal</td>
</tr>
<tr>
<td>s1 &gt; s2</td>
<td>s1 sorts after s2</td>
</tr>
<tr>
<td>s1 &lt; s2</td>
<td>s1 sortf before s2</td>
</tr>
</tbody></table>
<h4 id="Integer-Expressions"><a href="#Integer-Expressions" class="headerlink" title="Integer Expressions"></a>Integer Expressions</h4><table>
<thead>
<tr>
<th>command</th>
<th>description</th>
</tr>
</thead>
<tbody><tr>
<td>int1 -eq int2</td>
<td>equal</td>
</tr>
<tr>
<td>int1 -ne int2</td>
<td>not equal</td>
</tr>
<tr>
<td>-le</td>
<td>less or equal</td>
</tr>
<tr>
<td>-lt</td>
<td>less than</td>
</tr>
<tr>
<td>-ge</td>
<td>greater or equal</td>
</tr>
<tr>
<td>-gt</td>
<td>greater</td>
</tr>
</tbody></table>
<h4 id="A-More-Modern-Version-of-test"><a href="#A-More-Modern-Version-of-test" class="headerlink" title="A More Modern Version of test"></a>A More Modern Version of test</h4><ul>
<li><strong>Designed of string</strong><ul>
<li><code>[[ command ]]</code></li>
</ul>
</li>
</ul>
<p>and here is a new feature:<br><code>string1 =~ regex</code>. This return true if string1 matched by the extended regular expression</p>
<ul>
<li><strong>Designed of Integer</strong><ul>
<li>`(( command ))</li>
<li>integer only</li>
</ul>
</li>
</ul>
<h3 id="case"><a href="#case" class="headerlink" title="case"></a>case</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> word <span class="keyword">in</span></span><br><span class="line">    [pattern [| pattern]...) commands ;;]...</span><br><span class="line"><span class="keyword">esac</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> <span class="variable">$num</span> <span class="keyword">in</span></span><br><span class="line">    0) <span class="built_in">echo</span> <span class="string">"zero"</span></span><br><span class="line">        ;;  <span class="comment"># ;; break and out of case</span></span><br><span class="line">    ...</span><br><span class="line"><span class="keyword">esac</span></span><br></pre></td></tr></table></figure>

<h4 id="pattern"><a href="#pattern" class="headerlink" title="pattern"></a>pattern</h4><table>
<thead>
<tr>
<th>pattern</th>
<th>description</th>
</tr>
</thead>
<tbody><tr>
<td>a)</td>
<td>matches if word equals a</td>
</tr>
<tr>
<td>[[:alpha:]]</td>
<td>matches if word is a single alphabetic</td>
</tr>
<tr>
<td>???)</td>
<td>matches if word is exactly three characters long</td>
</tr>
<tr>
<td>*.txt</td>
<td>matches if word ends with .txt</td>
</tr>
<tr>
<td>*)</td>
<td>matches any value.</td>
</tr>
</tbody></table>
<h3 id="for-while-until"><a href="#for-while-until" class="headerlink" title="for/while/until"></a>for/while/until</h3><ul>
<li>for <ul>
<li><code>for variable in words; do commands done</code></li>
<li><code>for (( expression1; expression2; expression3 )); do commands done</code></li>
</ul>
</li>
<li>while <ul>
<li><code>while commands; do commands; done</code></li>
<li>while commands is true continue</li>
</ul>
</li>
<li>until <ul>
<li><code>until commands; do commands; done</code></li>
<li>while commands is false continue</li>
</ul>
</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/01/23/universe/regular_expression/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/01/23/universe/regular_expression/" itemprop="url">正则表达式基础语法</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-01-23T00:00:00+08:00">
                2020-01-23
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <ul>
<li><code>.</code><ul>
<li>匹配任何一个字符</li>
</ul>
</li>
<li><code>*</code><ul>
<li>匹配任何数量(包括0)的前面的内容，贪婪匹配</li>
</ul>
</li>
<li><code>+</code><ul>
<li>匹配任何数量(不包括0)的前面的内容，非贪婪匹配</li>
</ul>
</li>
<li><code>$</code><ul>
<li>以前面的内容结束</li>
</ul>
</li>
<li><code>^</code><ul>
<li>以前面的内容开头</li>
</ul>
</li>
<li><code>\S</code><ul>
<li>任何非空白字符</li>
</ul>
</li>
<li><code>\s</code><ul>
<li>任何空白字符</li>
</ul>
</li>
<li><code>?</code><ul>
<li>前面内容是可选的</li>
</ul>
</li>
<li><code>\</code><ul>
<li>有时可以起到转意的作用，<code>\S</code>等就是例外</li>
</ul>
</li>
<li><code>[0-9]</code><ul>
<li>任何0到9的数字，范围可变但要按顺序</li>
</ul>
</li>
<li><code>[a-z]</code><ul>
<li>任何a到z的小写字符，范围可变但要按顺序</li>
</ul>
</li>
<li><code>[A-Z]</code><ul>
<li>任何A到Z的大写字符，范围可变但要按顺序</li>
</ul>
</li>
<li><code>[A-Za-z]</code><ul>
<li>任何A到Z的字符，范围可变但要按顺序</li>
</ul>
</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/12/10/Major/compuer_organization/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/12/10/Major/compuer_organization/" itemprop="url">Computer Organization</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-12-10T00:00:00+08:00">
                2019-12-10
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><ul>
<li>从纯文本的程序到可执行的编码，以<code>hello.c</code>为例<ul>
<li>预处理：把头文件的内容直接插入程序文本。结果得到另一个c程序，通常以.i结尾</li>
<li>编译：编译器将本文文件hello.i翻译成文本文件hello.s，它包含一个汇编语言程序</li>
<li>汇编：汇编器将hello.s翻译成机器指令(编码)，把这些指令打包成一种叫做可重定位目标程序的格式，并将结果保存在目标文件hello.o中(一个二进制文件)。</li>
<li>链接：hello程序可能会用到许多函数，如printf。printf函数存在与一个名为printf.o的单独编译的与编译好了的目标文件中，这个文件需要以某种形式合并到我们的hello.o程序中。链接器就负责处理这种合并</li>
</ul>
</li>
</ul>
<ul>
<li>虚拟内存：虚拟内存是一个抽象概念，它为每个进程提供一个假象，即每个进程都在单独的使用主存。每个进程看到的内存都是一致的，称为虚拟地址空间</li>
<li>虚拟地址空间的结构：<ul>
<li>程序代码和数据</li>
<li>堆：代码和数据区在进程一开始运行时就被指定了大小，与此不同，当调用像malloc和free这样的函数时，堆可以在运行时动态伸缩</li>
<li>共享库：大约在地址空间的中间部分是一块用来存放像C标准这样的共享库的代码和数据的区域</li>
<li>栈</li>
<li>内核虚拟内存：地址空间的顶部区域是为内核保留的。不允许任何程序的读写</li>
</ul>
</li>
</ul>
<h2 id="程序结构和执行"><a href="#程序结构和执行" class="headerlink" title="程序结构和执行"></a>程序结构和执行</h2><h3 id="整数运算"><a href="#整数运算" class="headerlink" title="整数运算"></a>整数运算</h3><h4 id="无符号加法"><a href="#无符号加法" class="headerlink" title="无符号加法"></a>无符号加法</h4><p>考虑两个非负整数x和y，满足$0 \leq x, y&lt;2^w$。每个数都能表示为w为无符号数字。如果计算他们的和，我们就有一个可能的范围$0 \leq x+y \leq 2^{w+1} - 2$，表示这个和可能需要w+1位。对于固定精度的编程语言会发生溢出。</p>
<p>我们为x和y定义运算$+^u_w, 其中0 \leq x, y &lt; 2^w$，该操作是把整数和x+y截断为w位得到的结果。这也可以被视为一种形式的模运算，对于x+y的位级表示，简单的丢弃任何权重大于$2^{w-1}$的位就可以计算出和模$2^w$。如考虑一个4位数字表示$x=12, y=9,x+y=21([10101])$如果丢掉最高位，我们的到[0101]，也就是十进制的5。也就和值21 mod 16 = 6一致。</p>
<blockquote>
<p>定义$+^u_w$:</p>
<p>对于满足$0 \leq x, y &lt; 2^w$的x和y有</p>
<p>$$<br>x+^u_w y =<br>\begin{cases}<br>x+y&amp; ,{x+y&lt;2^w}&amp; 正常\<br>x+y-2^w&amp; ,{2^w \leq x+y &lt; 2^{w+1}}&amp; 溢出<br>\end{cases}<br>$$</p>
</blockquote>
<p>如何判断是否发生了溢出：</p>
<ul>
<li>原理：对在范围$0 \leq x, y \leq UMax_w$中的x和y，令$s = x +^u_w y$。则对计算是，当且仅当s&lt;x(或等价地s&lt;y)时发生溢出</li>
<li>推导：显然$x+y \geq x$，因此如果s没有溢出$s \geq x$。如果s发生溢出，有$s = x+y-2^w$，假设$y &lt; 2^w$，有$y-2^w &lt; 0$，因此$s = x+(y-2^w) &lt; x$</li>
</ul>
<h4 id="乘以常数"><a href="#乘以常数" class="headerlink" title="乘以常数"></a>乘以常数</h4><p>整数乘法指令相当慢，需要多个时钟周期，然而其他的整数运算(如加法、减法、位移)之需要1个时钟周期。因此编译器使用了一项重要的优化：试着用移位和加法运算的组合来代替乘以常数因子的乘法。</p>
<p>如$x \times 14$，$14=2^3+2^2+2^1$，编译器将乘法重写为(x&lt;&lt;3)+(x&lt;&lt;2)+(x&lt;&lt;1)，将一个乘法代替为3个移位和2个加法。甚至还可以$14=2^4-2^1$。</p>
<p>到这里，无符号数和补码的结果还是相同的</p>
<h4 id="除以2的幂"><a href="#除以2的幂" class="headerlink" title="除以2的幂"></a>除以2的幂</h4><p>在大多数机器上，整数除法要比整数乘法更慢：需要30个或者更多的时钟周期。除以2的幂也可以通过用移位(左移)运算来实现。</p>
<p>无符号和补码数分别使用逻辑移位和算数移位来达到目的：</p>
<ul>
<li>逻辑移位<ul>
<li>移出的空位用0补上</li>
</ul>
</li>
<li>算术移位<ul>
<li>对于无符号型，算术移位等同于逻辑移位</li>
<li>对于有符号型，算数左移等同于逻辑左移，算数右移补的是符号位</li>
</ul>
</li>
</ul>
<blockquote>
<p>定义$\lfloor a \rfloor$为向下舍入，$\lceil a \rceil$为向上舍入。</p>
</blockquote>
<p>对于$x \geq 0$和$y&gt;0$，结果会是$\lfloor x/y \rfloor$，对于$x&lt;0$和$y&gt;0$，结果会是$\lceil x/y \rceil$。也就是说要向下舍入一个正值，而向上舍入一个负值。</p>
<ul>
<li>除以2的幂的无符号数除法<ul>
<li>很简单，就直接右移，产生$\lfloor x/2^k \rfloor$</li>
</ul>
</li>
<li>除以2的幂的补码，正值情况，向下舍入<ul>
<li>也是直接右移，直接右移的结果是向下舍入的</li>
</ul>
</li>
<li>除以2的幂的补码，负值情况，向上舍入<ul>
<li>不能直接右移，因为直接右移导致结果向下舍入，而我们需要向上舍入</li>
<li>执行算数右移前要加上一个适当的偏执量才能使得结果正确舍入</li>
<li>表达式：(x+(1&lt;&lt;k)-1)&gt;&gt;k产生数值$\lceil x/2^k \rceil$</li>
<li>偏置技术利用如下属性：对于整数x和y(y&gt;0)，$\lceil x/y \rceil=\lfloor (x+y-1)/y \rfloor$。这样就可以通过逻辑移位来的到向上取整的结果了</li>
<li><strong>推导:</strong> $\lceil x/y \rceil=\lfloor (x+y-1)/y \rfloor$，设$x = qy+r$，其中$0 \leq r &lt; y$，得到(x+y-1)/y=q+(r+y-1)，因此$\lfloor (x+y-1)/y \rfloor = q + \lfloor (r+y-1)/y \rfloor$。当r=0时，后面一项等于0，当r&gt;0时，等于1。级通过给x增加一个偏移量y-1,然后再将除法向下舍入，当y整除x时，我们得到q，否则，得到q+1。</li>
</ul>
</li>
</ul>
<h3 id="浮点数"><a href="#浮点数" class="headerlink" title="浮点数"></a>浮点数</h3><h4 id="IEEE浮点数表示"><a href="#IEEE浮点数表示" class="headerlink" title="IEEE浮点数表示"></a>IEEE浮点数表示</h4><p>定点表示法不能很有效地表示非常大的数字。我们希望通过给定x和y的值，来表示形如$x \times 2^y$的数。</p>
<blockquote>
<p>IEEE浮点数标准用$V = (-1)^s \times M \times 2^E$的形式来表示一个数：</p>
<ul>
<li>符号(sign)<ul>
<li>s决定是负数(s=1)还是正数</li>
</ul>
</li>
<li>尾数(significand) M<ul>
<li>M是一个二进制小数，它的取值范围是[1, 2)或[0, 1)</li>
<li>有n位小数字段$frac=f_{n-1}…f_0$编码尾数M，但编码出来的值也依赖于阶码字段是否等于0(规格化的和非规格化的)</li>
</ul>
</li>
<li>阶码(exponent) E<ul>
<li>E的作用是对浮点数加权，这个权重是2的E次幂</li>
<li>由k位的阶码字段组成$exp=e_{k-1}…f_0$来编码阶码E</li>
</ul>
</li>
</ul>
</blockquote>
<ul>
<li>以下是两种常见的格式：单精度和双精度<ul>
<li>单精度:s、exp、frac字段分别为1位、k=8位和n=23位，得到一个32位的表示</li>
<li>双精度:s、exp、frac字段分别为1位、k=11位和n=52位，得到一个64位的表示</li>
</ul>
</li>
<li>给定位的表示，根据exp的值，被编码的值可以分成三种不同的情况(最后一种情况有两种变种)<ul>
<li>规格化的<ul>
<li>exp字段既不全为0也不全为1</li>
<li>阶码的值E=e-Bias，e是无符号数，而$Bias=2^{k-1}-1$的偏置值</li>
<li>尾数M=1+f，f是frac字段描述的小数值$0 \leq f &lt; 1$</li>
</ul>
</li>
<li>非规格化的值<ul>
<li>exp字段全为0时</li>
<li>阶码E=1-Bias</li>
<li>尾数M=f</li>
<li>注意和规格化的区别</li>
</ul>
</li>
<li>特殊值<ul>
<li>当exp全为1，frac字段全为0时，得到的值表示无穷</li>
<li>当exp全为1，frac字段不全为0时，得到的值表示NaN(Not a Number)</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>示例：假定用6位格式表示，k=3的阶码位和n=2的尾数位，如下</p>
<table>
<thead>
<tr>
<th>描述</th>
<th>位表示</th>
<th>e</th>
<th>E</th>
<th>$2^E$</th>
<th>f</th>
<th>M</th>
<th>$2^E \times M$</th>
<th>V</th>
<th>十进制</th>
<th>公式</th>
</tr>
</thead>
<tbody><tr>
<td>0</td>
<td>0 0000 000</td>
<td>0</td>
<td>-6</td>
<td>$\frac1{64}$</td>
<td>$\frac08$</td>
<td>$\frac08$</td>
<td>$\frac0{512}$</td>
<td>0</td>
<td>0.0</td>
<td>E=1-Bias</td>
</tr>
<tr>
<td>最小非规格化数</td>
<td>0 0000 001</td>
<td>0</td>
<td>-6</td>
<td>$\frac1{64}$</td>
<td>$\frac18$</td>
<td>$\frac18$</td>
<td>$\frac1{512}$</td>
<td>$\frac1{512}$</td>
<td>0.001953</td>
<td>M=f</td>
</tr>
<tr>
<td></td>
<td>0 0000 010</td>
<td>0</td>
<td>-6</td>
<td>$\frac1{64}$</td>
<td>$\frac28$</td>
<td>$\frac38$</td>
<td>$\frac2{512}$</td>
<td>$\frac1{256}$</td>
<td>0.003906</td>
<td></td>
</tr>
<tr>
<td>…</td>
<td>…</td>
<td>…</td>
<td>..</td>
<td>…</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>最大非规格化数</td>
<td>0 0000 111</td>
<td>0</td>
<td>-6</td>
<td>$\frac1{64}$</td>
<td>$\frac78$</td>
<td>$\frac78$</td>
<td>$\frac7{512}$</td>
<td>$\frac7{512}$</td>
<td>0.013672</td>
<td></td>
</tr>
<tr>
<td>——–</td>
<td>——</td>
<td>–</td>
<td>–</td>
<td>—</td>
<td>—-</td>
<td>—-</td>
<td>——</td>
<td>—–</td>
<td>—–</td>
<td></td>
</tr>
<tr>
<td>最小规格化数</td>
<td>0 0001 000</td>
<td>1</td>
<td>-6</td>
<td>$\frac1{64}$</td>
<td>$\frac08$</td>
<td>$\frac88$</td>
<td>$\frac8{512}$</td>
<td>$\frac1{64}$</td>
<td>0.015625</td>
<td>E=e-Bias</td>
</tr>
<tr>
<td></td>
<td>0 0001 001</td>
<td>1</td>
<td>-6</td>
<td>$\frac1{64}$</td>
<td>$\frac18$</td>
<td>$\frac98$</td>
<td>$\frac9{512}$</td>
<td>$\frac9{256}$</td>
<td>0.017578</td>
<td>M=1+f</td>
</tr>
<tr>
<td>…</td>
<td>…</td>
<td>…</td>
<td>..</td>
<td>…</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td>0 1110 110</td>
<td>14</td>
<td>7</td>
<td>128</td>
<td>$\frac68$</td>
<td>$\frac{14}8$</td>
<td>$\frac{1792}8$</td>
<td>224</td>
<td>224</td>
<td></td>
</tr>
<tr>
<td>最大规格化数</td>
<td>0 1110 111</td>
<td>14</td>
<td>7</td>
<td>128</td>
<td>$\frac78$</td>
<td>$\frac{15}8$</td>
<td>$\frac{1920}8$</td>
<td>240</td>
<td>240</td>
<td></td>
</tr>
<tr>
<td>——–</td>
<td>——</td>
<td>–</td>
<td>–</td>
<td>—</td>
<td>—-</td>
<td>—-</td>
<td>——</td>
<td>—–</td>
<td>—–</td>
<td></td>
</tr>
<tr>
<td>无穷大</td>
<td>0 1111 000</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>无穷</td>
<td>-</td>
<td></td>
</tr>
</tbody></table>
<h2 id="程序的机器级表示"><a href="#程序的机器级表示" class="headerlink" title="程序的机器级表示"></a>程序的机器级表示</h2><h3 id="数据格式"><a href="#数据格式" class="headerlink" title="数据格式"></a>数据格式</h3><table>
<thead>
<tr>
<th>C声明</th>
<th>Intel数据类型</th>
<th>汇编代码后缀</th>
<th>大小(字节)</th>
</tr>
</thead>
<tbody><tr>
<td>char</td>
<td>字节</td>
<td>b</td>
<td>1</td>
</tr>
<tr>
<td>short</td>
<td>字</td>
<td>w</td>
<td>2</td>
</tr>
<tr>
<td>int</td>
<td>双字</td>
<td>l</td>
<td>4</td>
</tr>
<tr>
<td>long</td>
<td>四字</td>
<td>q</td>
<td>8</td>
</tr>
<tr>
<td>char*</td>
<td>四字</td>
<td>q</td>
<td>8</td>
</tr>
<tr>
<td>float</td>
<td>单精度</td>
<td>s</td>
<td>4</td>
</tr>
<tr>
<td>double</td>
<td>双精度</td>
<td>l</td>
<td>8</td>
</tr>
</tbody></table>
<h3 id="访问信息"><a href="#访问信息" class="headerlink" title="访问信息"></a>访问信息</h3><p>一个x86-64的CPU包含一组16个储存64位值的通用目的寄存器。每个寄存器都有特殊的用途，它们的名字就反映了这些用途。</p>
<table>
<thead>
<tr>
<th>64寄存器</th>
<th>32位寄存器</th>
<th>16位寄存器</th>
<th>8位寄存器</th>
<th>用途</th>
</tr>
</thead>
<tbody><tr>
<td>%rax</td>
<td>%eax</td>
<td>%ax</td>
<td>%ax</td>
<td>返回值</td>
</tr>
<tr>
<td>%rbx</td>
<td>%ebx</td>
<td>%bx</td>
<td>%bl</td>
<td>被调用者保存</td>
</tr>
<tr>
<td>%rcx</td>
<td>%ecx</td>
<td>%cx</td>
<td>%cl</td>
<td>第4个参数</td>
</tr>
<tr>
<td>%rdx</td>
<td>%edx</td>
<td>%dx</td>
<td>%dl</td>
<td>第3个参数</td>
</tr>
<tr>
<td>%rsi</td>
<td>%esi</td>
<td>%si</td>
<td>%sil</td>
<td>第2个参数</td>
</tr>
<tr>
<td>%rdi</td>
<td>%edi</td>
<td>%di</td>
<td>%dil</td>
<td>第1个参数</td>
</tr>
<tr>
<td>%rbp</td>
<td>%ebp</td>
<td>%bp</td>
<td>%bpl</td>
<td>被调用者保存</td>
</tr>
<tr>
<td>%rsp</td>
<td>%esp</td>
<td>%sp</td>
<td>%spl</td>
<td>栈指针</td>
</tr>
<tr>
<td>%r8</td>
<td>%r8d</td>
<td>%r8w</td>
<td>%r8b</td>
<td>第5个参数</td>
</tr>
<tr>
<td>%r9</td>
<td>%r9d</td>
<td>%r9w</td>
<td>%r9b</td>
<td>第6个参数</td>
</tr>
<tr>
<td>%r10</td>
<td>%r10d</td>
<td>%r10w</td>
<td>%r10b</td>
<td>调用者保存</td>
</tr>
<tr>
<td>%r11</td>
<td>%r11d</td>
<td>%r11w</td>
<td>%r11b</td>
<td>调用者保存</td>
</tr>
<tr>
<td>%r12</td>
<td>%r12d</td>
<td>%r12w</td>
<td>%r12b</td>
<td>被调用者保存</td>
</tr>
<tr>
<td>%r13</td>
<td>%r13d</td>
<td>%r13w</td>
<td>%r13b</td>
<td>被调用者保存</td>
</tr>
<tr>
<td>%r14</td>
<td>%r14d</td>
<td>%r14w</td>
<td>%r14b</td>
<td>被调用者保存</td>
</tr>
<tr>
<td>%r15</td>
<td>%r15d</td>
<td>%r15w</td>
<td>%r15b</td>
<td>被调用者保存</td>
</tr>
</tbody></table>
<p>指令可以对这16个寄存器的低位字节中存放的不同大小的数据进行操作。</p>
<table>
<thead>
<tr>
<th>指令</th>
<th>功能</th>
</tr>
</thead>
<tbody><tr>
<td>*AX</td>
<td>累加器Accumulator</td>
</tr>
<tr>
<td>*BX</td>
<td>基地址寄存器Base Register</td>
</tr>
<tr>
<td>*CX</td>
<td>计数寄存器Count Register</td>
</tr>
<tr>
<td>*DX</td>
<td>数据寄存器Data Register</td>
</tr>
<tr>
<td>*BP</td>
<td>堆栈基指针Base Pointer</td>
</tr>
<tr>
<td>*SI/*DI</td>
<td>变址寄存器Index Register</td>
</tr>
<tr>
<td>*SP</td>
<td>堆栈顶指针Stack Pointer</td>
</tr>
<tr>
<td>*S</td>
<td>段寄存器Segement Register</td>
</tr>
</tbody></table>
<h2 id="MIPS体系结构"><a href="#MIPS体系结构" class="headerlink" title="MIPS体系结构"></a>MIPS体系结构</h2><p>Microprocessor without Interlocked Piped Stage，流水线不会互锁的处理器。避免不同指令间的相互影响。如x86指令的标志寄存器，前一条指令作出的改动会对后面的产生影响，这MIPS所要避免的。</p>
<ul>
<li>它的主要关注点<ul>
<li>减少指令类型</li>
<li>降低指令复杂度</li>
</ul>
</li>
<li>基本原则是用非常简单的CPU解决非常复杂的系统<ul>
<li>越简单的CPU越快</li>
</ul>
</li>
<li>MIPS特点<ul>
<li>固定指令长度(32bit)<ul>
<li>简化了从存储器取指令</li>
</ul>
</li>
<li>简单的寻址模式<ul>
<li>简化了从存储器取操作数</li>
</ul>
</li>
<li>指令数量少，功能简单<ul>
<li>一条指令之完成一个操作</li>
<li>简化指令的执行过程</li>
</ul>
</li>
<li>只允许Load和Store指令访问存储器</li>
<li>MIPS这些特点让使用MIPS进行编程变得困难</li>
</ul>
</li>
</ul>
<h3 id="基本指令"><a href="#基本指令" class="headerlink" title="基本指令"></a>基本指令</h3><ul>
<li>格式：<code>OPT a, b, c</code><ul>
<li>如<code>add a, b, c</code>将b和c求和，结果存如a中</li>
<li>如此还有<ul>
<li><code>sub a, b, c</code></li>
<li><code>mul a, b, c</code></li>
<li><code>div a, b, c</code></li>
<li><code>and a, b, c</code></li>
<li><code>or a, b, c</code></li>
<li><code>sll a, b, c</code>，左移</li>
<li><code>srl a, b, c</code>，右移</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>指令高度统一，而且操作数都不可是存储器操作数，要使用存储器就必须使用专门的访存指令。</p>
<ul>
<li><code>lw $a, $b</code>, load word，读取寄存器b的字(32bit)，放入a中<ul>
<li>MIPS的寄存器编号用<code>$</code>符进行标记</li>
</ul>
</li>
<li><code>sw $a, $b</code>, store word，将寄存器a的字(32bit)，存到b中</li>
</ul>
<p>MIPS有32个通用寄存器，编号从0到31，可以实用<code>$</code>加编号进行指示，也可使用他们的名称(每个寄存器都另有一个名称，并约定了特定的用途)</p>
<h3 id="指令的基本格式"><a href="#指令的基本格式" class="headerlink" title="指令的基本格式"></a>指令的基本格式</h3><p>MIPS的指令非常的精简</p>
<ul>
<li>按照功能划分<ul>
<li>运算指令</li>
<li>访存指令</li>
<li>分支指令</li>
</ul>
</li>
<li>从指令的格式划分<ul>
<li>R：Register，寄存器</li>
<li>I：Immediate，立即数</li>
<li>J：Jump，转移</li>
</ul>
</li>
</ul>
<h4 id="R型"><a href="#R型" class="headerlink" title="R型"></a>R型</h4><table>
<thead>
<tr>
<th>R</th>
<th>opcode</th>
<th>rs</th>
<th>rt</th>
<th>rd</th>
<th>shamt</th>
<th>funct</th>
</tr>
</thead>
<tbody><tr>
<td>大小(bit)</td>
<td>6</td>
<td>5</td>
<td>5</td>
<td>5</td>
<td>5</td>
<td>6</td>
</tr>
<tr>
<td>位置</td>
<td>31~26</td>
<td>25~21</td>
<td>20~16</td>
<td>15~11</td>
<td>10~6</td>
<td>5~0</td>
</tr>
</tbody></table>
<ul>
<li><p>R型指令的格式</p>
<ul>
<li>opcode域指定指令的类型，对于R型指令均为0</li>
<li>funct来精确指定指令的类型</li>
<li>rs：Source Register，通常指定第一个源操作数所在寄存器编号</li>
<li>rt：Target Register，通常指定第二个源操作数所在寄存器编号</li>
<li>rd：Destination Register，通常指定目的操作数所在寄存器编号</li>
<li>shamt用于指定移位指令进行操作数的位数，对于非移位指令为0</li>
</ul>
</li>
<li><p>通过指令得到编码，如<code>add $8, $9, $10</code></p>
<ul>
<li>查MIPS的指令编码表：对于add，opcode=0, funct=32, shamt=0</li>
<li>分析指令操作数：rd=8, rs=9, rt=10</li>
<li>把对应的值转化为二进制数即可得到编码</li>
</ul>
</li>
</ul>
<h4 id="I型"><a href="#I型" class="headerlink" title="I型"></a>I型</h4><p>如果只用5bit来表示立即数，显然不够用，所以对于I型指令需要新的格式</p>
<table>
<thead>
<tr>
<th>I</th>
<th>opcode</th>
<th>rs</th>
<th>rt</th>
<th>immediate</th>
</tr>
</thead>
<tbody><tr>
<td>大小(bit)</td>
<td>6</td>
<td>5</td>
<td>5</td>
<td>16</td>
</tr>
<tr>
<td>位置</td>
<td>31~26</td>
<td>25~21</td>
<td>20~16</td>
<td>15~0</td>
</tr>
</tbody></table>
<ul>
<li><p>I型指令的格式</p>
<ul>
<li>opcode域指定指令的类型，没有funct</li>
<li>funct来精确指定指令的类型</li>
<li>rs：Source Register，通常指定第一个源操作数所在寄存器编号</li>
<li>rt：Target Register，通常指定第二个源操作数所在寄存器编号</li>
<li>immediate可以存放16位的立即数</li>
</ul>
</li>
<li><p>通过指令得到编码，如<code>add $21, $22, -50</code></p>
<ul>
<li>opcode=8</li>
<li>rs=22, rt=21, immedaite=-50</li>
</ul>
</li>
</ul>
<h4 id="分支指令-条件指令"><a href="#分支指令-条件指令" class="headerlink" title="分支指令(条件指令)"></a>分支指令(条件指令)</h4><ul>
<li>条件分支<ul>
<li>根据比较结果改变控制流</li>
<li><code>beq</code>(branch if equal)<ul>
<li>opcode=4</li>
</ul>
</li>
<li><code>bne</code>(branch if not equal)<ul>
<li>opcode=5</li>
</ul>
</li>
</ul>
</li>
<li>非条件分支<ul>
<li>无条件地改变控制流</li>
<li><code>j</code>(jump)</li>
</ul>
</li>
</ul>
<p>格式：<code>bep reg1, reg2, L1</code><br>    - 前两个是寄存器操作数，第三个是存储器地址(一个立即数，偏移量)<br>    - 不同于x86指令，没有标志寄存器，在一条语句中完成了比较和转移</p>
<table>
<thead>
<tr>
<th>I</th>
<th>opcode</th>
<th>rs</th>
<th>rt</th>
<th>immediate</th>
</tr>
</thead>
<tbody><tr>
<td>大小(bit)</td>
<td>6</td>
<td>5</td>
<td>5</td>
<td>16</td>
</tr>
<tr>
<td>位置</td>
<td>31~26</td>
<td>25~21</td>
<td>20~16</td>
<td>15~0</td>
</tr>
</tbody></table>
<ul>
<li>如何发挥16bit的作用？<ul>
<li>以当前的PC为基准，16bit偏移量可以表示$\pm 2^{15}$bytes</li>
<li>由于MIPS指令长度固定为32bit，因此我们可以用16bit的立即数来表示每4个字节为一个单位的地址，这样目标地址范围可以扩大4倍。</li>
<li>16bit偏移量可以表示$\pm 2^{17}$bytes</li>
</ul>
</li>
<li>目标地址计算方法<ul>
<li>分支条件不成立时，PC = PC + 4 = 下一条语句</li>
<li>分支条件成立时，PC = PC + 4  + immediate*4</li>
</ul>
</li>
</ul>
<p>对于非条件分支指令</p>
<table>
<thead>
<tr>
<th>J</th>
<th>opcode</th>
<th>immediate</th>
</tr>
</thead>
<tbody><tr>
<td>大小(bit)</td>
<td>6</td>
<td>26</td>
</tr>
<tr>
<td>位置</td>
<td>31~26</td>
<td>25~0</td>
</tr>
</tbody></table>
<ul>
<li>不同于条件分支，需要两个寄存器比较，所以可以表示更大的范围</li>
<li>目标地址计算方法：New PC = {(PC+4)后取最高4位, address, 00}</li>
<li>J型指令的目标地址范围：<code>\pm 2^{28}</code>bytes<ul>
<li>如何到达更远的目标地址？<ul>
<li>两次调用j指令</li>
<li>使用jr指令：<code>jr rs</code>，可把要转移的目标地址放在寄存器中，这样就可以使用32位的目标地址</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="算数逻辑单元"><a href="#算数逻辑单元" class="headerlink" title="算数逻辑单元"></a>算数逻辑单元</h2><p>通过MIPS指令来做示例</p>
<h3 id="算数运算和逻辑运算"><a href="#算数运算和逻辑运算" class="headerlink" title="算数运算和逻辑运算"></a>算数运算和逻辑运算</h3><p>把编码好的指令，如<code>add r1, r2, r3</code>放入IR寄存器中，根据各个域的数值控制电路向ALU发出信号：输入、输出、运算方法等。</p>
<p>在如对于立即数加法：<code>addi</code>，ALU接受到信号，通过opcode知道要进行立即数加法，把把源寄存器作为输入，把输出放入目标寄存器。</p>
<ul>
<li>立即数是16bit的，但寄存器是32bit的，要能成功相加，需要扩展16bit<ul>
<li>MIPS使用补码，所以这个立即数采用符号扩展，不会改变补码的值</li>
</ul>
</li>
</ul>
<p>对于逻辑运算，与算数运算类似，只是立即数采用0扩展。</p>
<h3 id="门电路的基本原理"><a href="#门电路的基本原理" class="headerlink" title="门电路的基本原理"></a>门电路的基本原理</h3><p>现代集成电路通常使用MOS晶体管</p>
<ul>
<li>N型MOS管<ul>
<li>Source源：电流流入</li>
<li>Drain漏：电流流出</li>
<li>Gate门：控制，高电频导通</li>
</ul>
</li>
<li>P型MOS管<ul>
<li>Source源：电流流入</li>
<li>Drain漏：电流流出</li>
<li>Gate门：控制，低电频导通</li>
</ul>
</li>
<li>用这两种晶体管就构成了互补型的MOS关：CMOS</li>
</ul>
<p>逻辑门由晶体管构成，各种逻辑门的结构这里就不说了</p>
<h3 id="寄存器的原理"><a href="#寄存器的原理" class="headerlink" title="寄存器的原理"></a>寄存器的原理</h3><p>在MIPS结构中，寄存器是由32个位组成，从电路上来说每个bit都是一样的，都是一个 <strong>D触发器</strong>。</p>
<ul>
<li>D触发器<ul>
<li>具有存储信息能力的基本单元</li>
<li>由若干逻辑门构成，有多种实现方式</li>
<li>主要有1个数据输入、1个数据输出和1个时钟输入</li>
<li>在上升沿，采样输入D的值，传送到输出Q，其余时间输出Q的值不变</li>
<li>要求采样信号前后有一段很短的稳定时间</li>
</ul>
</li>
</ul>
<p>用32个D触发器构成MIPS的寄存器，在将寄存器用逻辑门相连，就构成了CPU。</p>
<h3 id="逻辑运算的实现"><a href="#逻辑运算的实现" class="headerlink" title="逻辑运算的实现"></a>逻辑运算的实现</h3><p>ALU中包含很多中运算单元，以与元算单元为例：32位的输入需要32个与逻辑门处理，得到对应的32位输出。ALU包含多个单元，一组输入通过不同的单元，的到多组输出，这时需要一个多选器根据选择信号(opcode)对这些输出进行选择，得到一个32位的输出。</p>
<h3 id="加减法的实现"><a href="#加减法的实现" class="headerlink" title="加减法的实现"></a>加减法的实现</h3><ul>
<li><p>半加器</p>
<ul>
<li>将两个一位二进制数相加</li>
<li>不能将进位位用与加法</li>
</ul>
</li>
<li><p>全加器</p>
<ul>
<li>由两个半加器组成</li>
<li>能将进位位用与加法</li>
</ul>
</li>
<li><p>MIPS对溢出的处理方式</p>
<ul>
<li>将操作数看做有符号数<code>add</code>和<code>addi</code><ul>
<li>发生溢出时会产生异常</li>
</ul>
</li>
<li>将操作数看做无符号数<code>addu</code>和<code>addiu</code><ul>
<li>不处理溢出</li>
</ul>
</li>
</ul>
</li>
<li><p>x86对溢出的处理方式</p>
<ul>
<li>采用溢出标志OF，根据标志寄存器OF来进行相应的操作</li>
</ul>
</li>
</ul>
<p>对于减法运算，减法可以转换成加法，那么就要对一个数进行取反操作</p>
<ul>
<li>补码表示的二进制数取反<ul>
<li>规则：按位取反，末位加一</li>
<li>推导 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">x :010101</span><br><span class="line">~x:101010</span><br><span class="line">----------</span><br><span class="line">-1:111111</span><br><span class="line"></span><br><span class="line">x + (~x) &#x3D; -1</span><br><span class="line"></span><br><span class="line">(~x) + 1 &#x3D; -x</span><br></pre></td></tr></table></figure>

</li>
</ul>
</li>
</ul>
<h3 id="加法器的优化"><a href="#加法器的优化" class="headerlink" title="加法器的优化"></a>加法器的优化</h3><p>前面将的加法有一个个的全加器串联而成，需要等待进位输入，延迟长。进位像波一样传递，这样的加法器也称为 <strong>行波进位加法器(RCA)</strong> 。</p>
<ul>
<li>超前进位加法器(CLA)<ul>
<li>优点： <ul>
<li>计算延迟时间固定为三级门延迟</li>
</ul>
</li>
<li>缺点：<ul>
<li>进一步扩宽加法器的位数，则电路变得非常复杂</li>
</ul>
</li>
<li>因此通常使用小规模的CLA拼接形成加法器</li>
</ul>
</li>
</ul>
<h2 id="乘法器和除法器"><a href="#乘法器和除法器" class="headerlink" title="乘法器和除法器"></a>乘法器和除法器</h2><p>整数乘法指令相当慢，需要多个时钟周期，然而其他的整数运算(如加法、减法、位移)之需要1个时钟周期。因此编译器使用了一项重要的优化：试着用移位和加法运算的组合来代替乘以常数因子的乘法。</p>
<p>如$x \times 14$，$14=2^3+2^2+2^1$，编译器将乘法重写为(x&lt;&lt;3)+(x&lt;&lt;2)+(x&lt;&lt;1)，将一个乘法代替为3个移位和2个加法。甚至还可以$14=2^4-2^1$。</p>
<h3 id="乘法器的实现"><a href="#乘法器的实现" class="headerlink" title="乘法器的实现"></a>乘法器的实现</h3><p>观察下列乘法过程：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">   1000</span><br><span class="line">   1001</span><br><span class="line">   ------</span><br><span class="line">   1000</span><br><span class="line">  0000_   好似乘数左移乘</span><br><span class="line"> 0000__</span><br><span class="line">1000___</span><br></pre></td></tr></table></figure>

<p>一个N位乘法器需要3个寄存器，分别设为被乘数md，乘mr，结果res。由上列过程得到启发，过程如下：</p>
<ul>
<li><p>如果被乘数第一位不为0则乘以乘数</p>
</li>
<li><p>把结果加到res中</p>
</li>
<li><p>乘数右移，被乘数左移</p>
</li>
<li><p>如果执行了N次则乘法结束，否则回到第一步</p>
</li>
<li><p>对N位乘法器进行优化</p>
<ul>
<li><ol>
<li>加法移位并行<ul>
<li>通过控制器，控制移位，在一个时钟周期完成移位操作</li>
</ul>
</li>
</ol>
</li>
<li><ol start="2">
<li>减少不必要的硬件资源<ul>
<li>md由于左移，储存需要的位数是它原始位宽的两倍<ul>
<li>取消左移</li>
</ul>
</li>
<li>mr右移有效数字每个周期减少1位<ul>
<li>用res的低4为存放，因此可以取消mr</li>
</ul>
</li>
<li>res每个周期增加1位<ul>
<li>增加右移，来代替md的左移，乘积始终放在高4位</li>
</ul>
</li>
<li>加法器参加运输，但实际有效数字自由其位宽的一半<ul>
<li>md和res的高4位进行运算</li>
</ul>
</li>
</ul>
</li>
</ol>
</li>
</ul>
</li>
</ul>
<h3 id="除法的运算过程"><a href="#除法的运算过程" class="headerlink" title="除法的运算过程"></a>除法的运算过程</h3><p>观察除法的运算过程</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">         0001        结果累加，相当于左移</span><br><span class="line">        0001</span><br><span class="line">       0000</span><br><span class="line">      0000</span><br><span class="line">     0000            0010&lt;0000所以商为0</span><br><span class="line">0010&#x2F;00000111</span><br><span class="line">     0010____        相当于右移</span><br><span class="line">      0010</span><br><span class="line">       0010</span><br><span class="line">        0010</span><br><span class="line">        ----</span><br><span class="line">         0011</span><br><span class="line">         0010</span><br><span class="line">         ----</span><br><span class="line">            1        记录余数</span><br></pre></td></tr></table></figure>

<p>过程如下</p>
<ul>
<li>余数寄存器减去除数，检测最高位判断大小</li>
<li>除数右移</li>
<li>商左移，累加</li>
</ul>
<p>除法器的优化:</p>
<ul>
<li><ol>
<li>硬件资源优化<ul>
<li>除数寄存器实际只用了一半</li>
<li>商寄存器初始的空的，从右到左逐位填满</li>
<li>余数初始是满的，有意义的位从左到右逐位减少</li>
</ul>
</li>
</ol>
</li>
<li><ol start="2">
<li>性能资源优化</li>
</ol>
</li>
</ul>
<h2 id="单周期处理器"><a href="#单周期处理器" class="headerlink" title="单周期处理器"></a>单周期处理器</h2><h3 id="处理器设计的主要步骤"><a href="#处理器设计的主要步骤" class="headerlink" title="处理器设计的主要步骤"></a>处理器设计的主要步骤</h3><ul>
<li><ol>
<li>分析指令系统，得出对数据通路的需求</li>
</ol>
</li>
<li><ol start="2">
<li>为数据通路选择合适的组件</li>
</ol>
</li>
<li><ol start="3">
<li>连接组件建立数据通路</li>
</ol>
</li>
<li><ol start="4">
<li>分析每条指令的实现，以确定控制信号</li>
</ol>
</li>
<li><ol start="5">
<li>集成控制信号，形成完整的控制逻辑，控制器</li>
</ol>
</li>
</ul>
<p>下面以一个简化的MIPS指令系统作为实例，改系统的指令有：</p>
<ul>
<li>无符号加法和和减法<ul>
<li><code>addu rd, rs, rt</code></li>
<li><code>subu rd, rs, rt</code></li>
</ul>
</li>
<li>立即数的逻辑或<ul>
<li><code>ori rt, rs, imm16</code></li>
</ul>
</li>
<li>装载和储存一个字<ul>
<li><code>lw rt, imm16(rs)</code></li>
<li><code>sw rt, imm16(rs)</code></li>
</ul>
</li>
<li>条件分支<ul>
<li><code>bep rs, rt, imm16</code></li>
</ul>
</li>
</ul>
<table>
<thead>
<tr>
<th>R</th>
<th>opcode</th>
<th>rs</th>
<th>rt</th>
<th>rd</th>
<th>shamt</th>
<th>funct</th>
</tr>
</thead>
<tbody><tr>
<td>大小(bit)</td>
<td>6</td>
<td>5</td>
<td>5</td>
<td>5</td>
<td>5</td>
<td>6</td>
</tr>
<tr>
<td>位置</td>
<td>31~26</td>
<td>25~21</td>
<td>20~16</td>
<td>15~11</td>
<td>10~6</td>
<td>5~0</td>
</tr>
</tbody></table>
<ul>
<li><p>指令位域分解</p>
<ul>
<li>R型指令：{op, rs, rt, rd, shamt, funct}</li>
<li>I型指令：{op, rs, rt, imm16}</li>
<li>需求：<ul>
<li>存放指令的存储器</li>
<li>PC:存放地址的32位寄存器</li>
</ul>
</li>
</ul>
</li>
<li><p>通过指令操作分析需求</p>
<ul>
<li>运算指令需求：<ul>
<li>一组存放数据的通用寄存器，这些寄存器称为寄存器堆</li>
<li>同时读取两个寄存器的内容</li>
<li>写入一个寄存器的内容，保存结果</li>
<li>将16位的立即数扩展到32位，供I型指令需要</li>
<li>提供加、减、逻辑或功能的运算器</li>
<li>运算器的操作数可以时寄存器或立即数</li>
</ul>
</li>
<li>访存指令<ul>
<li>存放数据的储存器，可读可写</li>
<li>将16位的立即数扩展到32位，供I型指令需要</li>
</ul>
</li>
<li>分支指令<ul>
<li>比较内容，判断是否相等</li>
<li>PC寄存器支持两种自增方式，加4或加一个立即数</li>
</ul>
</li>
</ul>
</li>
<li><p>整理：</p>
<ul>
<li>算数逻辑单元(ALU)<ul>
<li>支持运算类型</li>
<li>操作数</li>
</ul>
</li>
<li>立即数扩展部件<ul>
<li>支持0扩展、符号扩展</li>
</ul>
</li>
<li>程序计数器(PC)<ul>
<li>支持两种自增方式，加4或加一个立即数</li>
</ul>
</li>
<li>寄存器堆<ul>
<li>支持读操作：rs和rt</li>
<li>支持写操作：rt和rd</li>
</ul>
</li>
<li>存储器<ul>
<li>一个只读指令存储器</li>
<li>一个可读写的数据存储器</li>
</ul>
</li>
</ul>
</li>
<li><p>寄存器堆</p>
<ul>
<li>内部构成<ul>
<li>32个32位的寄存器</li>
</ul>
</li>
<li>数据接口信号<ul>
<li>busA、busB：两组32位的数据输出</li>
<li>busW：一组32位的数据输入</li>
</ul>
</li>
<li>读写控制<ul>
<li>Ra(5bit)：选中对应编号的寄存器，将其内容放到busA</li>
<li>Rb(5bit)：选中对应编号的寄存器，将其内容放到busB</li>
<li>Rw(5bit)：选中对应编号的寄存器，在时钟信号的上升沿，如果写使能信号有效，将busW的内容写入改寄存器</li>
<li>读操作不受时钟信号控制</li>
</ul>
</li>
</ul>
</li>
<li><p>存储器</p>
<ul>
<li>数据接口信号<ul>
<li>Date In：32位的数据输入信号</li>
<li>Data Out：32位的数据输出信号</li>
</ul>
</li>
<li>读写操作<ul>
<li>Address：32位的地址信号。该信号指定一个存储单元，将其内容送到数据输入信号</li>
<li>Write Enable：写使能信号，在时钟上升沿，如果写使能信号有效，将数据输入信号的内容存入地址信号指定的存储单元</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="数据通路的建立"><a href="#数据通路的建立" class="headerlink" title="数据通路的建立"></a>数据通路的建立</h3><ul>
<li>基本原则<ul>
<li>根据指令需求，连接组件，建立数据通路</li>
</ul>
</li>
<li>指令的需求<ul>
<li>所有指令的共同需求<ul>
<li>取指令，由IFU(Instruction Fetch Unit)完成<ul>
<li>程序计数器(PC)的内容是指令的地址</li>
<li>用PC的内容作为地址，访问指令存储器获得指令编码</li>
</ul>
</li>
<li>更新程序计数器PC<ul>
<li>顺序时PC+=4</li>
<li>分支时PC=目标地址</li>
</ul>
</li>
</ul>
</li>
<li>不同指令的各自需求<ul>
<li>加减法指令的需求</li>
<li>逻辑运算指令的需求</li>
<li>访存指令需求</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="运算指令的控制信号"><a href="#运算指令的控制信号" class="headerlink" title="运算指令的控制信号"></a>运算指令的控制信号</h3><p>以加法运算指令为例：</p>
<ul>
<li><ol>
<li>通过IFU取指令</li>
</ol>
</li>
<li><ol start="2">
<li>执行加法<ul>
<li>解析IFU的输出，放入寄存器堆对应的输入中</li>
<li>busB如果是立即数需要扩展<ul>
<li>扩展又有0扩展和符号扩展</li>
</ul>
</li>
<li>对ALU：给ALU信号使其执行加法计算</li>
<li>对数据存储器：如果不需要数据存储器，写使能信号关闭，防止对结果修改</li>
<li>要写入寄存器，所有要把寄存器的写使能信号设为有效</li>
</ul>
</li>
</ol>
</li>
<li><ol start="3">
<li>更新PC寄存器的内容</li>
</ol>
</li>
</ul>
<p>访存指令、分支指令同理</p>
<h3 id="控制信号的集成"><a href="#控制信号的集成" class="headerlink" title="控制信号的集成"></a>控制信号的集成</h3><p>把之前的控制信号集成起来，形成完整的控制逻辑。</p>
<h2 id="流水线处理器"><a href="#流水线处理器" class="headerlink" title="流水线处理器"></a>流水线处理器</h2><h3 id="流水线的基本原理"><a href="#流水线的基本原理" class="headerlink" title="流水线的基本原理"></a>流水线的基本原理</h3><p>执行MIPS指令的主要步骤：</p>
<ul>
<li>取值</li>
<li>译码</li>
<li>执行</li>
<li>访存</li>
<li>回写</li>
</ul>
<p>分工明确好似非常适合使用流水线，每个人专注于自己的工作，每个硬件都有使用。</p>
<p>我们需要将每个部分的输出放入一个流水线寄存器，这样当输出保存在流水线寄存器后，前面的寄存器就可以开始新的工作而不影响后面的工作。下一个硬件又从流水线寄存器中取上一个硬件的输入。</p>
<p>虽然每条指令要经历的时间不变，但是当流水线填满是，每个时钟周期都能产生一条指令，性能提升不少。</p>
<h3 id="流水线的优化"><a href="#流水线的优化" class="headerlink" title="流水线的优化"></a>流水线的优化</h3><p>如果只是简单的按照指令执行的步骤取切分流水线的话不能充分发挥流水线的优势。</p>
<p>时钟周期的大小取决于耗时最长的那个步骤，如果流水线平衡性较差，性能提升幅度下降。</p>
<p>流水线的深度并非越深越好，应用流水线寄存器也会产生时延。越深的流水线说明需要的流水线寄存器越多。单条指令的执行时间越长。</p>
<h3 id="超标量流水线"><a href="#超标量流水线" class="headerlink" title="超标量流水线"></a>超标量流水线</h3><p>除了增加流水线深度来提供速度，还有一种方式就是拓宽流水线，这样的流水线就称为超标量流水线。通常具有两条或以上并行工作的流水线称为超标量结构。也可称为超量。</p>
<h3 id="流水线的”冒险”"><a href="#流水线的”冒险”" class="headerlink" title="流水线的”冒险”"></a>流水线的”冒险”</h3><ul>
<li>“冒险”(Hazard)：阻止下一条指令在下一个时钟周期开始执行的情况<ul>
<li>结构冒险<ul>
<li>所有的硬件部件正在位之前的指令工作</li>
<li>对于只读存储器，一次只能有一个硬件进行读取<ul>
<li>解决方案1：流水线停顿(不同时使用这个硬件)，产生空泡(不会影响状态的值)<ul>
<li>但如果等待后有与另一个硬件冲突则又要停顿，这样效率很低</li>
</ul>
</li>
<li>解决方案2：指令和数据放在不同的存储器中</li>
</ul>
</li>
<li>对于可读写的寄存器，读写同时发生显然不是一个明智的选择<ul>
<li>解决方案：前半个时钟周期写，后半个读，并设置独立的读写口</li>
<li>支持这么做的原因是寄存器的读写速度较快</li>
</ul>
</li>
</ul>
</li>
<li>数据冒险<ul>
<li>需要等待之前的指令完成数据的读写</li>
<li>如果下一条指令需要上一条指令的数据，但是上一条指令可能还没写回<ul>
<li>解决方案1：停顿</li>
</ul>
</li>
</ul>
</li>
<li>控制冒险<ul>
<li>需要根据之前指令的结果决定下一步的行为</li>
<li>类似数据冒险，指令不能确定是否发生分支，需要几个周期后才知道<ul>
<li>解决方案1：停顿</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="数据冒险的处理"><a href="#数据冒险的处理" class="headerlink" title="数据冒险的处理"></a>数据冒险的处理</h3><ul>
<li>软件解决方案(停顿)：插入nop指令，什么都不干<ul>
<li>插入几条nop指令存在问题，不同的处理器的流水线深度可能不同，导致兼容。因此一般不通过软件层面解决硬件问题</li>
</ul>
</li>
<li>流水线停顿，产生空泡<ul>
<li>这样的空泡由硬件产生</li>
<li>检查数据冒险，如果有则插入空泡</li>
</ul>
</li>
<li>数据前递(或称为旁路)<ul>
<li>如加法运算，即使没有写回，它的运算结果其实已经在流水线寄存器中了，我们只需引用流水线寄存器上的值</li>
<li>但对于load指令数据前递不适用，因为load指令的值较迟产生</li>
</ul>
</li>
</ul>
<h3 id="控制冒险的处理"><a href="#控制冒险的处理" class="headerlink" title="控制冒险的处理"></a>控制冒险的处理</h3><ul>
<li>当执行了转移指令，并确实发生转移时，产生如下的开销，称为”转移开销”<ul>
<li><ol>
<li>将按顺序预取的指令废除(排空流水线)</li>
</ol>
</li>
<li><ol start="2">
<li>从转移目标地址重新取指定</li>
</ol>
</li>
</ul>
</li>
<li>转移开销的构成<ul>
<li>要不要转移，判断条件引起的开销</li>
<li>转移到哪，生成目标地址引起的开销</li>
</ul>
</li>
</ul>
<h2 id="存储层次结构"><a href="#存储层次结构" class="headerlink" title="存储层次结构"></a>存储层次结构</h2><h3 id="概况"><a href="#概况" class="headerlink" title="概况"></a>概况</h3><ul>
<li>冯诺依曼计算机结构：<ul>
<li>运算器CA</li>
<li>控制器CC</li>
<li>存储器M<ul>
<li>层次结构：<ul>
<li>通用寄存器：CPU</li>
<li>高速缓存：SRAM</li>
<li>主存：DRAM</li>
<li>本地二级存储：Disk</li>
<li>越往上越快、容量越小价格越高</li>
</ul>
</li>
</ul>
</li>
<li>输入I</li>
<li>输出O</li>
</ul>
</li>
</ul>
<h3 id="DRAM和SRAM"><a href="#DRAM和SRAM" class="headerlink" title="DRAM和SRAM"></a>DRAM和SRAM</h3><table>
<thead>
<tr>
<th></th>
<th>DRAM</th>
<th>SRAM</th>
</tr>
</thead>
<tbody><tr>
<td>储存单元</td>
<td>电容</td>
<td>双稳态触发器</td>
</tr>
<tr>
<td>集成度</td>
<td>高</td>
<td>低</td>
</tr>
<tr>
<td>功耗</td>
<td>低</td>
<td>高</td>
</tr>
<tr>
<td>价格</td>
<td>低</td>
<td>高</td>
</tr>
<tr>
<td>速度</td>
<td>慢</td>
<td>块</td>
</tr>
<tr>
<td>刷新</td>
<td>有</td>
<td>无</td>
</tr>
</tbody></table>
<h3 id="主存-内存-的工作原理"><a href="#主存-内存-的工作原理" class="headerlink" title="主存(内存)的工作原理"></a>主存(内存)的工作原理</h3><p>DRAM芯片以一个存储阵列位核心，通过指定行列地址取出对应的存储单元(4比特或8比特)。一个内存条往往有多个DRAM芯片(4的倍数)，构成一个内存模组。从外部给入行列地址后地址会同时送到每个DRAM芯片，每个DRAM芯片同时选择储存器单元，存储单元同时输出，组成一个64/32位的数。</p>
<p>缓存速度很快，一般放在CPU中。CPU访问内存的过程：SDRAM(同步DRAM)的访存过程为例：</p>
<ul>
<li>CPU通过系统总线连接到内存控制器，内存控制器再通过存储总线连接到内存条<ul>
<li>CPU需要访问控制器时：<ul>
<li>申请系统总线，获得总线控制权后把地址发到控制器中</li>
</ul>
</li>
<li>控制器对地址分解形成行地址和列地址，然后向DRAM发起访存操作<ul>
<li><ol>
<li>预充电</li>
</ol>
</li>
<li><ol start="2">
<li>行访问:DRAM中的行译码芯片，选出对应行，所有单元的信号放大后放在一个缓冲区</li>
</ol>
</li>
<li><ol start="3">
<li>缓冲区信号稳定后，才能发出列地址，其中tRCD是冲行选到列选的延迟</li>
</ol>
</li>
<li><ol start="4">
<li>列译码器接受到列地址后，从缓冲区读出对应的列，放到数据接受接口。其中从发出列地址到选出对应存储单元的数的过程称为列访问，这段时间称为CL</li>
</ol>
</li>
</ul>
</li>
<li>内存送出数据后，控制器采样并送到CPU<ul>
<li>如果CPU的下次请求是同一行，则控制器不再发送行地址，而是直接发送列地址</li>
<li>如果下次访问不是同一行则需把缓冲区的行关闭，这个过程就叫做 <strong>预充电</strong> </li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="主存技术的发展"><a href="#主存技术的发展" class="headerlink" title="主存技术的发展"></a>主存技术的发展</h3><ul>
<li>DDR:Double Data Rate<ul>
<li>时钟的上升沿和下降沿都传输</li>
</ul>
</li>
<li>SDR:Single Data Rate<ul>
<li>只在时钟的上升沿传输</li>
</ul>
</li>
</ul>
<p>building</p>
<h3 id="高速缓存的工作原理"><a href="#高速缓存的工作原理" class="headerlink" title="高速缓存的工作原理"></a>高速缓存的工作原理</h3><p>$$Cpu \leftrightarrow Cache \leftrightarrow Main Memory$$</p>
<ul>
<li>程序的局部性原理:计算机程序从空间和时间都表现出局部性<ul>
<li>时间局部性<ul>
<li>最近被访问的存储器单元(指令或数据)很快会被访问</li>
</ul>
</li>
<li>空间局部性<ul>
<li>正在被访问的存储器单元附近的单元很快会被访问到</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>举个例子：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;<span class="number">10</span>; i++)&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> j=<span class="number">0</span>; j&lt;<span class="number">10</span>; i++)&#123;</span><br><span class="line">        sum+=a[i][j];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// i很快会(频繁)被访问</span></span><br><span class="line"><span class="comment">// a数组附件的单元很快会被访问</span></span><br></pre></td></tr></table></figure>

<ul>
<li><p>cache的基本原理</p>
<ul>
<li>cache对空间局部性的利用<ul>
<li>从主存中取回待访问数据时，会同时取回与位置相邻的主存单元的数据</li>
<li>以数据块(Block)为单位和主存进行数据交换</li>
</ul>
</li>
<li>cache对时间局部性的利用<ul>
<li>保存近期频繁被访问的主存单元的数据</li>
</ul>
</li>
<li>这样如果cache中有数据(cache命中)则从cache中获取</li>
</ul>
</li>
<li><p>cache的写策略</p>
<ul>
<li>cache命中时的写策略<ul>
<li>写穿透：数据同时写入cache和主存</li>
<li>写返回：数据只写入cache，仅当改数据块被替换时才写入主存</li>
</ul>
</li>
<li>cache失效时的写策略<ul>
<li>写不分配：直接写入主存</li>
<li>写分配：将该数据所在的块读入cache后，在将数据写入cache，利用局部性原理</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="高速缓存的设计要点"><a href="#高速缓存的设计要点" class="headerlink" title="高速缓存的设计要点"></a>高速缓存的设计要点</h3><ul>
<li>平均访存时间(Average Memory Access Time)=Hit Time + Miss Penalty x Miss Rate<ul>
<li>Hit Time：命中时间，从cache将命中数据返回的时间</li>
<li>Miss Penalty：失效代价，从主存读取数据并返回的时间</li>
<li>Miss Rate：失效率，未命中的概率</li>
<li>降低访存时间主要就是降低这3个参数</li>
</ul>
</li>
<li>cache失效的原因<ul>
<li>义务失效：第一次访问<ul>
<li>无法避免</li>
</ul>
</li>
<li>容量失效：无法保存程序所需的所有数据块<ul>
<li>可增加cache容量缓解，但会增加命中时间</li>
</ul>
</li>
<li>冲突失效：多个存储器位置映射到同一个cache位置<ul>
<li>需要精心设计映射策略</li>
</ul>
</li>
</ul>
</li>
<li>映射策略<ul>
<li>直接映射</li>
<li>多路组相联(相当于用几个表来保存，但是表越多就要用越复杂的电路判断是否在其中一个表中)</li>
<li>常见的cache替换算法<ul>
<li>随机</li>
<li>轮换</li>
<li>最近最少使用(LRU)：效果最好但设计复杂</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="存储器容量的计算"><a href="#存储器容量的计算" class="headerlink" title="存储器容量的计算"></a>存储器容量的计算</h3><table>
<thead>
<tr>
<th>&lt;++&gt;</th>
<th>&lt;++&gt;</th>
</tr>
</thead>
<tbody><tr>
<td>Ki:kibi</td>
<td>$1024^1$</td>
</tr>
<tr>
<td>Mi:mebi</td>
<td>$1024^2$</td>
</tr>
<tr>
<td>..</td>
<td>..</td>
</tr>
</tbody></table>
<h2 id="中断和异常"><a href="#中断和异常" class="headerlink" title="中断和异常"></a>中断和异常</h2><h3 id="中断向量表的结构"><a href="#中断向量表的结构" class="headerlink" title="中断向量表的结构"></a>中断向量表的结构</h3><p>不同的中断产生不同的中断码，根据中断向量表查询得到对应的处理方法。</p>
<ul>
<li>中断向量：中断服务程序的入口地址</li>
<li>中断向量表存放在固定的地址</li>
<li>处理方法会事先存放在中断向量对应的地址处</li>
</ul>
<h3 id="中断的处理过程"><a href="#中断的处理过程" class="headerlink" title="中断的处理过程"></a>中断的处理过程</h3><ul>
<li><ol>
<li>关中断<ul>
<li>CPU关闭中断响应，不再接受其他外部中断请求</li>
</ul>
</li>
</ol>
</li>
<li><ol start="2">
<li>保存断点<ul>
<li>将发送中断处理的指令压入堆栈，处理完后正确返回</li>
</ul>
</li>
</ol>
</li>
<li><ol start="3">
<li>识别中断源<ul>
<li>确定中断类型号，从而找到相应的中断处理程序的入口地址</li>
</ul>
</li>
</ol>
</li>
<li><ol start="4">
<li>保存现场<ul>
<li>保存正在处理的程序</li>
</ul>
</li>
</ol>
</li>
<li><ol start="5">
<li>执行中断服务程序<ul>
<li>转到中断服务程序入口开始执行，可在适当的时刻重新开放中断，以便允许相应较高优先级的外部中断</li>
<li>重新开放由标识寄存器控制</li>
</ul>
</li>
</ol>
</li>
<li><ol start="6">
<li>恢复现场(8086为例)<ul>
<li>IRET指令(中断返回)，从栈顶弹出3个字分别送入IP、CS和FLAGS寄存器</li>
<li>放在中断服务程序的末尾</li>
</ul>
</li>
</ol>
</li>
</ul>
<h3 id="基于中断的功能调用"><a href="#基于中断的功能调用" class="headerlink" title="基于中断的功能调用"></a>基于中断的功能调用</h3><ul>
<li>指令<code>int N</code><ul>
<li>调用n号中断,由运行指令主动触发</li>
</ul>
</li>
</ul>
<h2 id="输入输出设备"><a href="#输入输出设备" class="headerlink" title="输入输出设备"></a>输入输出设备</h2><h3 id="输入输出接口的基本功能"><a href="#输入输出接口的基本功能" class="headerlink" title="输入输出接口的基本功能"></a>输入输出接口的基本功能</h3><ul>
<li>I/O接口改的基本功能<ul>
<li>数据缓冲<ul>
<li>解决CPU和外设之间的速度差距</li>
</ul>
</li>
<li>提供联络信息<ul>
<li>协调与同步数据交换过程</li>
</ul>
</li>
<li>信号与信息格式的转换<ul>
<li>模/数、数/模交换，串/并、并/串交换，电平转换</li>
</ul>
</li>
<li>设备选择</li>
<li>中断管理</li>
<li>可编程功能</li>
</ul>
</li>
</ul>
<h3 id="输入输出接口的编址方式"><a href="#输入输出接口的编址方式" class="headerlink" title="输入输出接口的编址方式"></a>输入输出接口的编址方式</h3><ul>
<li>I/O端口和存储器分开编址<ul>
<li>I/O映像的I/O方式，I/O Mapped I/O</li>
<li>x86就是这种方式</li>
<li>I/O指令<ul>
<li>IN指令<ul>
<li><code>IN AC, PORT</code></li>
<li>把外设端口内容输入到AL或AX</li>
</ul>
</li>
<li>OUT指令<ul>
<li><code>OUT PORT, AC</code></li>
<li>把AL或AX的内容输出到外设端口</li>
</ul>
</li>
<li>端口地址小于255时可以用立即数，否则需要寄存器</li>
</ul>
</li>
</ul>
</li>
<li>I/O端口和存储器统一编址<ul>
<li>存储器映像的I/O方式，Memory Mapped I/O</li>
<li>MIPS就是这种方式</li>
<li>优点<ul>
<li>可以用访问存储器的指令访问I/O端口，可以实现直接对I/O端口内的数据进行处理</li>
<li>CPU中的I/O操作与访问存储器的操作统一为一套控制逻辑，简化内部结构，减少PCU引脚的数目</li>
</ul>
</li>
<li>缺点<ul>
<li>I/O端口占用一部分存储器地址空间，使得存储器地址空间减小</li>
<li>由于利用访问存储器的指令来进行IO操作，指令的长度通常比单独IO指令要长，执行时间也较长</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="输入输出的控制方式"><a href="#输入输出的控制方式" class="headerlink" title="输入输出的控制方式"></a>输入输出的控制方式</h3><ul>
<li>IO控制方式的分类<ul>
<li>程序控制方式<ul>
<li>无条件传送方式<ul>
<li>假设外设已经准备号</li>
<li>CPU直接使用指令与外设传送数据</li>
<li>不查询外设的工作状态</li>
</ul>
</li>
<li>程序查询传送方式<ul>
<li>CPU通过指令一段程序，不断查询外设的工作状态<ul>
<li>握手信号，检查输入输出缓冲</li>
</ul>
</li>
<li>在外设准备就绪后草进行数据传送</li>
<li>CPU的不断查询浪费了很多资源</li>
</ul>
</li>
</ul>
</li>
<li>中断控制方式<ul>
<li>通过中断的方式，将数据”一块一块”地传送，当输入输出缓冲达到一定条件时，引发中断，提醒CPU的继续输入或读取等</li>
<li>优点<ul>
<li>CPU可和外设并行工作</li>
<li>外围设备具有申请父亲的主动权</li>
<li>一定程度上满足了IO处理的实时性要求</li>
</ul>
</li>
<li>缺点<ul>
<li>输入输出的数据仍由CPU承担</li>
<li>进入和退出中断增加消耗</li>
</ul>
</li>
</ul>
</li>
<li>直接存储器访问(DMA)方式<ul>
<li>前面的方式的共同确定是数据传输仍由CPU承担，但是如果是显示器，网络等需要大量数据传输的设备就难以应对了</li>
<li>Direct Memory Access(DMA)<ul>
<li>数据传送过程不需要CPU干预(不需要指令程序指令)</li>
<li>由专门的硬件控制电路控制，进行外设与存储器间直接数据传送</li>
<li>该专门硬件控制电路称为DMA控制器，简称DMAC</li>
</ul>
</li>
<li>DMAC的基本工作步骤(以使用独立DMAC进行外设到内存传送为例)<ul>
<li><ol>
<li>CPU设置DMAC内部配置寄存器<ul>
<li>源地址的初始值以及传送是的地址增减方式</li>
<li>目的地址的初始值以及传送是的地址增减方式</li>
<li>待传送数据的长度</li>
</ul>
</li>
</ol>
</li>
<li><ol start="2">
<li>DMAC处于空闲等待状态</li>
</ol>
</li>
<li><ol start="3">
<li>IO接口向DMAC传送申请</li>
</ol>
</li>
<li><ol start="4">
<li>DMAC响应IO接口的申请</li>
</ol>
</li>
<li><ol start="5">
<li>DMAC向IO接口发起总线读传输</li>
</ol>
</li>
<li><ol start="6">
<li>DMAC向存储器发起总线写传输</li>
</ol>
</li>
<li><ol start="7">
<li>重复5～6直到本次DMA传送完成</li>
</ol>
</li>
<li><ol start="8">
<li>返回2，等待下一次DMA传送申请</li>
</ol>
</li>
</ul>
</li>
<li>通常，DMA传送完成后DMAC会通过中断信号通知CPU</li>
</ul>
</li>
</ul>
</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/2/">&lt;i class&#x3D;&quot;fa fa-angle-left&quot;&gt;&lt;&#x2F;i&gt;</a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" href="/page/4/">&lt;i class&#x3D;&quot;fa fa-angle-right&quot;&gt;&lt;&#x2F;i&gt;</a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">John Doe</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/%20%7C%7C%20archive">
              
                  <span class="site-state-item-count">46</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            

            
              
              
              <div class="site-state-item site-state-tags">
                
                  <span class="site-state-item-count">42</span>
                  <span class="site-state-item-name">tags</span>
                
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">John Doe</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
